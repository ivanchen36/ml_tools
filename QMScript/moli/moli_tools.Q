[General]
SyntaxVersion=2
BeginHotkey=116
BeginHotkeyMod=0
PauseHotkey=0
PauseHotkeyMod=0
StopHotkey=120
StopHotkeyMod=0
RunOnce=1
EnableWindow=
MacroID=109c6746-c249-48e6-b123-3a408be7fc20
Description=moli_tools
Enable=0
AutoRun=0
[Repeat]
Type=0
Number=1
[SetupUI]
Type=1
QUI=p1
[Relative]
SetupOCXFile=
[Comment]

[UIPackage]
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


[Script]
Dimenv WND_NUM, NORMAL_SPEED, EAST, SOUTH, NORTH, WEST, EAST_SOUTH, EAST_NORTH, WEST_SOUTH, WEST_NORTH
DimEnv EAST_X, SOUTH_X, NORTH_X, WEST_X, EAST_SOUTH_X, EAST_NORTH_X, WEST_SOUTH_X, WEST_NORTH_X
DimEnv EAST_Y, SOUTH_Y, NORTH_Y, WEST_Y, EAST_SOUTH_Y, EAST_NORTH_Y, WEST_SOUTH_Y, WEST_NORTH_Y
DimEnv eventType, lastEventType, isRun, operateName
DimEnv taskType, currentHwnd, currentIndex, wndStatus, selectWnds
Dimenv statusMsg, msg1, msg2, msg3, msg4, msg5, msg6
DimEnv wnd1Name, wnd2Name, wnd3Name, wnd4Name, wnd5Name, wnd6Name
Dimenv S_RUN, S_WAIT, S_STOP
Dimenv TASK_ZHUAN_3, TASK_ZHUAN_4, TASK_ZHUAN_5,TASK_EGG,TASK_YES_FIGHT,TASK_NO_FIGHT,TASK_JINGYAN,TASK_BAI_REN,TASK_YI_FEI
Dimenv isTeam, exeStatus, teamStatus, currentTeamStatus
Dim eventThreadId, isLeader
Dim curX, curY, wndIndex
Dim hwndArr(6)
Dim yifei1, yifei2

Function baiduOcr(filePath)
    Dim tokenurl, ocrUrl, token, image, js, data, lines, k, client_id, client_secret, ret
    client_id = "eUxLQLkIqz7GCfhK5THhzGII"
    client_secret = "hbfa1svZKSxbPc99GjoSK6sWFYbGalHq "
    tokenurl = "https://aip.baidubce.com/oauth/2.0/token?" & "grant_type=client_credentials&client_id=" & client_id & "&client_secret=" & client_secret
    set http = createobject("msxml2.xmlhttp")
    http.open "post",tokenurl,false
    http.send
    If http.responsetext = "" Then
        TracePrint "获取access_token 失败"
        Exit Function
    End If
    Set js = createobject("scriptcontrol")
    js.language = "jscript"
    js.addcode "var data={}"
    js.addcode "data = " & http.responsetext
    token = js.eval("data.access_token")
    //========================================================
    image = pictobase64(filePath)
    If image <> "" then
        data = "image=" & image
        ocrUrl = "https://aip.baidubce.com/rest/2.0/ocr/v1/general_basic"
        http.open "post", ocrUrl & "?access_token=" & token, false
        http.setRequestHeader "CONTENT-TYPE","application/x-www-form-urlencoded"
        http.setRequestHeader "Content-Length",len(image)
        http.send data
        js.addcode "data=" & http.responsetext
        TracePrint http.responsetext
        lines = js.eval("data.words_result_num")
        TracePrint lines
        ret = ""
        if lines > 0 then
            for k = 0 to lines - 1
                TracePrint js.eval("data.words_result[" & k & "].words")
                ret = ret & js.eval("data.words_result[" & k & "].words")
            next
        End If
        TracePrint ret
    End If
End Function

function pictobase64(filepath) '此函数借用了别人的
    Dim xml, root, fs, objStream, objXMLDoc, Base64,i,j
    Set objXMLDoc=CreateObject("Microsoft.XMLDOM")
    objXMLDoc.loadXML "<?xml version='1.0' ?><data></data>"
    Set fs = createObject("Scripting.FileSystemObject")
    If not fs.FileExists(FilePath) Then exit function
    Set objStream = CreateObject("ADODB.Stream")
    objStream.Type = 1
    objStream.Open
    objStream.LoadFromFile FilePath
    objXMLDoc.documentElement.dataType = "bin.Base64"
    objXMLDoc.documentElement.nodeTypedvalue = objStream.Read
    Set xml = CreateObject("Microsoft.XMLDOM")
    xml.load objXMLDoc
    If not xml.ReadyState > 2 Then exit function
    Set root = xml.getElementsByTagName("data")
    Base64 = root.Item(0).Text
    Base64 = Replace(Base64, vbLf, "")
    Set xml = Nothing
    Set objStream = Nothing
    Set fs=Nothing
    Set objXMLDoc = Nothing
    Base64 = Replace(Base64, "%", Chr(1))
    Base64 = Replace(Base64, "+", Chr(2))
    For i = 0 To 255
        If i=1 or i =37 or i = 43 or (i >=48 and i <= 57) or (i>=65 and i <=90 ) or (i>=97 and i <=122) then
            'Delay 1
        ElseIf i = 2 then
            Base64 = Replace(Base64, Chr(i), "%2B")
        ElseIf i = 32 then
            Base64 = Replace(Base64, Chr(i), "+")
        Elseif (i>=3 and i <=15 ) then
            Base64 = Replace(Base64, Chr(i), "%0" & Hex(i))
        Else
            Base64 = Replace(Base64, Chr(i), "%" & Hex(i))
        End If
    Next
    pictobase64 = base64
End Function

Function initEnv()
    NORMAL_SPEED = 8
    EAST = 1
    SOUTH = 2
    WEST = 3
    NORTH = 4
    EAST_SOUTH = 5
    EAST_NORTH = 6
    WEST_SOUTH = 7
    WEST_NORTH = 8 
    S_RUN = 1
    S_WAIT = 2
    S_STOP = 3
    S_EXIT = 4
    isRun = S_STOP
    TASK_ZHUAN_3 = 1
    TASK_ZHUAN_4 = 2
    TASK_ZHUAN_5 = 3
    TASK_EGG = 5
    TASK_YES_FIGHT = 6
    TASK_NO_FIGHT = 7
    TASK_JINGYAN = 8
    TASK_BAI_REN = 9
    TASK_YI_FEI = 10
    WND_NUM = 6
    eventType = 0
    lastEventType = 0
End Function
Function init()
    Dim i
    For i = 0 To WND_NUM - 1
        hwndArr(i) = 0
    Next
    selectWnd = 0
End Function
Function initDm()
    Dim ret
    Plugin.RegDll.Reg ".\dm\dm.dll"
    Set dm = createobject("dm.dmsoft")
    ret = dm.SetPath (".\dm")
    ret = dm.SetDict(0, "font\ml_pos.txt")
    ret = dm.SetDict(1, "font\ml_map.txt")
    ret = dm.SetDict(2, "font\ml_dialog.txt")
    ret = dm.SetDict(3,"font\ml_name.txt")
End Function
Function initSelected()
    selectWnds = 0
    If 1 = p1.wnd1.Value Then 
        selectWnds = selectWnds Or (2 ^ 0)
    End If
    If 1 = p1.wnd2.Value Then 
        selectWnds = selectWnds Or (2 ^ 1)
    End If
    If 1 = p1.wnd3.Value Then 
        selectWnds = selectWnds Or (2 ^ 2)
    End If
    If 1 = p1.wnd4.Value Then 
        selectWnds = selectWnds Or (2 ^ 3)
    End If
    If 1 = p1.wnd5.Value Then 
        selectWnds = selectWnds Or (2 ^ 4)
    End If
    If 1 = p1.wnd6.Value Then 
        selectWnds = selectWnds Or (2 ^ 5)
    End If
End Function
Function lineMove(targetX, targetY, speed)
    Dim ret, i
    Dim perX, perY, moveNum
    Dim moveDisX, moveDisY
    dm.GetCursorPos curX, curY
    moveDisX = targetX - curX
    moveDisY = targetY - curY
    If Abs(moveDisX) > (moveDisY) Then 
        moveNum = Clng(Abs(moveDisX) / speed) + 1
    Else 
        moveNum = Clng(Abs(moveDisY) / speed) + 1
    End If
    perX = moveDisX / moveNum
    perY = moveDisY / moveNum
    For i = 1 To moveNum
        curX = curX + perX
        curY = curY + perY
        If i = moveNum Then 
            curX = targetX
            curY = targetY
        End If
        dm.MoveTo curX,curY
        Delay(20) + myRnd(20)
    Next
End Function
Function findMyPic(startX, startY,endX,endY, picName, isMove)
    dm.FindPic startX,startY,endX,endY,picName, "000000", 0.9, 0, intX,intY
    If intX > 0 And intY > 0 Then 
        If isMove Then 
            lineMove intX + 6, intY + 5, NORMAL_SPEED
        End If
        findMyPic = True
    Else 
        findMyPic = False
    End If
End Function
Function isFree()
    Dim ret1, i
    ret1 = dm.CmpColor(400, 10, "addbcf-000000", 0.99)
    If 0 = ret1 Then 
        ret1 = dm.CmpColor(403,30,"addbcf-000000", 0.99)
    End If
    If 0 = ret1 Then
        isFree = True
        For i = 0 To 10
        	Delay 500 + myRnd(500)
        	ret1 = dm.CmpColor(294, 240, "99eef2-000000", 0.99)
        	If 0 = ret1 Then 
        		Exit For
        	End If
        Next
    Else 
        isFree = False
    End If
End Function
Function goHome()
    If isFree = False Then 
        Delay myRnd(1000) + 1000
        goHome = False
    Else 
        dm.KeyPressChar "/"
        Delay 100 + myRnd(100)
        dm.KeyPressChar "h"
        Delay 100 + myRnd(100)
        dm.KeyPressChar "c"
        Delay 200 + myRnd(100)
        dm.KeyPressChar "enter"
        goHome = True
        Delay 200 + myRnd(100)
    End If
End Function

Function joinTeam()
	dm.KeyDownChar "Ctrl"
	Delay myRnd(100) + 200
	dm.KeyPressChar "L"
	Delay myRnd(200) + 100
	dm.KeyUpChar "Ctrl"
	Delay myRnd(300) + 300
	dm.KeyPressChar "back"
	Delay myRnd(500) + 500
End Function

Function breakTeam()
	joinTeam 
	currentTeamStatus = 0
	isTeam = False
End Function

Function createTeam(mapName, mapX, mapY, direct)
	Dim tmpPos, ret1
	
	createTeam = False
	If (currentTeamStatus And (2 ^ wndIndex)) > 0 Then 
		createTeam = True
		Exit Function
	End If
	
	ret1 = walkTo(mapName, mapX, mapY, direct, "")
	If Not ret1  Then 
		Exit Function
	End If

	If isLeader Then 
		tmpPos = getDirectGamePos(direct, 1)
		ret1 = walkTo(mapName, tmpPos(0), tmpPos(1), direct, "")
		If Not ret1 Then 
			Exit Function
		End If

		currentTeamStatus = currentTeamStatus Or (2 ^ wndIndex)
		setMsg "等待队员归队"
		Do While True
			If currentTeamStatus = teamStatus Then 
				setMsg "队伍集结完毕"
				Exit Do
			End If
			
		 	Delay 500 + myRnd(500)
		Loop
		createTeam = True
		isTeam = True
		Exit Function
	End If
	
	joinTeam 
	Delay 500 + myRnd(200)
	tmpPos = getDirectGamePos((direct + 1) Mod 8 + 1, 1)
	ret1 = walkTo(mapName, tmpPos(0), tmpPos(1), 0, "")
	If Not ret1 Then 
		joinTeamOnPos = True
		setMsg "归队成功"
		currentTeamStatus = currentTeamStatus Or (2 ^ wndIndex)
	Else 
		setMsg "归队失败，等待重试"
		ret1 = walkTo(mapName, tmpPos(0), tmpPos(1), direct, "")
	End If
End Function

Function fight(direct, needConfirm, isYes)
	Dim ret1, i, num
    faceTo direct
    num = myRnd(5)
    For i = 1 To num
    	dm.KeyPressChar "space"
    	Delay 100 + myRnd(100)
    Next
    dm.KeyPressChar "enter"
    Delay 600 + myRnd(500)
    If needConfirm Then
        Delay myRnd(800) + 800
        ret1 = clickConfirm(isYes)
        If Not ret1 Then 
        	lineMove 179 + myRnd(264), 62 + myRnd(70), NORMAL_SPEED * 2
        	clickConfirm(isYes)
    	End If
    End If
    Delay myRnd(500) + 500
    If isFree Then 
        fight = False
    Else 
        fight = True
    End If
End Function
Function flushWnd()
    Dim hwnds, i, arr
    msg1 = "调用大漠插件获取窗口句柄。"
    hwnds = dm.EnumWindowByProcess("hjml.EXE", "", "", 8 + 16)
    arr = split(hwnds, ",")
    msg1 = "获取窗口句柄成功，" & hwnds
    For i = 0 To WND_NUM - 1	
        If i > UBOUND(arr) Then
            hwndArr(i) = 0
        Else 
            hwndArr(i) = Clng(arr(i))
        End If
    Next
    wnd1Name = ""
    wnd2Name = ""
    wnd3Name = ""
    wnd4Name = ""
    wnd5Name = ""
    wnd6Name = ""
    If hwndArr(0) > 0 Then 
        wnd1Name = dm.GetWindowTitle(hwndArr(0))
    End If
    If hwndArr(1) > 0 Then 
        wnd2Name = dm.GetWindowTitle(hwndArr(1))
    End If
    If hwndArr(2) > 0 Then 
        wnd3Name = dm.GetWindowTitle(hwndArr(2))
    End If
    If hwndArr(3) > 0 Then 
        wnd4Name = dm.GetWindowTitle(hwndArr(3))
    End If
    If hwndArr(4) > 0 Then 
        wnd5Name = dm.GetWindowTitle(hwndArr(4))
    End If
    If hwndArr(5) > 0 Then 
        wnd6Name = dm.GetWindowTitle(hwndArr(5))
    End If
    msg1 = "窗口初始化完成，" & hwnds
End Function
Function disableControls()
    isRun = S_RUN
    p1.wnd1.Enabled = 0
    p1.wnd2.Enabled = 0
    p1.wnd3.Enabled = 0
    p1.wnd4.Enabled = 0
    p1.wnd5.Enabled = 0
    p1.wnd6.Enabled = 0
    p1.bt1.Enabled = 0
    p1.bt2.Enabled = 0
    p1.bt3.Enabled = 0
    p1.bt4.Enabled = 0
    p1.bt5.Enabled = 0
    p1.bt6.Enabled = 0
    p1.bt7.Enabled = 0
    p1.bt8.Enabled = 0
    p1.bt9.Enabled = 0
    p1.bt10.Enabled = 0
End Function
Function enableControls()
    isRun = S_STOP
    p1.wnd1.Enabled = 1
    p1.wnd2.Enabled = 1
    p1.wnd3.Enabled = 1
    p1.wnd4.Enabled = 1
    p1.wnd5.Enabled = 1
    p1.wnd6.Enabled = 1
    p1.bt1.Enabled = 1
    p1.bt2.Enabled = 1
    p1.bt3.Enabled = 1
    p1.bt4.Enabled = 1
    p1.bt5.Enabled = 1
    p1.bt6.Enabled = 1
    p1.bt7.Enabled = 1
    p1.bt8.Enabled = 1
    p1.bt9.Enabled = 1
    p1.bt10.Enabled = 1
    p1.stop.Enabled = 1
End Function

Function log(str)
	Dim fileName
	fileName = "log\wnd" & wndIndex + 1 & ".log"
	dm.WriteFile fileName, Now & " : " & str & Chr(13) &Chr(10)
End Function

Function setMsg(message)
    If 0 = wndIndex Then 
        msg1 = message
    End If
    If 1 = wndIndex Then 
        msg2 = message
    End If
    If 2 = wndIndex Then 
        msg3 = message
    End If
    If 3 = wndIndex Then 
        msg4 = message
    End If
    If 4 = wndIndex Then 
        msg5 = message
    End If
    If 5 = wndIndex Then 
        msg6 = message
    End If
    log (message)
End Function

Function zhuansheng3()
    Dim free, ret1, fightErr, err1, err2
    fightErr = 0
    err1 = 0
    err2 = 0
    Do While S_RUN = isRun
        If fightErr > 1 Or err1 > 3 Or err2 > 3 Then
            setMsg "错误次数过多，停止执行"
            Exit Do
        End If
        free = isFree()
        If free Then
            setMsg "使用羽毛传送"
            ret1 = useItem("img\yumao.bmp", True)
            If ret1 Then
                err1 = 0
                Delay 500 + myRnd(500)
                setMsg "前往boss面前 23, 16"
                ret1 = walkTo("佛梯", 23, 16, 0, "")
                If ret1 Then 
                    err2 = 0
                    setMsg "确认战斗"
                    ret1 = fight(NORTH, True, True)
                    If False = ret1 Then 
                    	setMsg "进入战斗失败"
                        fightErr = fightErr + 1
                    Else 
                    	setMsg "开始战斗"
                        fightErr = 0
                    End If
                Else
                    setMsg "地图出错，重试"
                    Delay 2000 + myRnd(1000) 
                    err2 = err2 + 1
                End If
            Else
                setMsg "使用羽毛传送出错，重试"
                Delay 2000 + myRnd(1000)
                err1 = err1 + 1
            End If
        Else 
            setMsg "战斗中..."
            Delay 2000 + myRnd(2000)
        End If
    Loop
End Function
Function zhuansheng4()
    Dim free, ret1, fightErr, err1, err2
    fightErr = 0
    err1 = 0
    err2 = 0
    Do While S_RUN = isRun
        If fightErr > 1 Or err1 > 3 Or err2 > 3 Then
            setMsg "错误次数过多，停止执行"
            Exit Do
        End If
        free = isFree()
        If free Then
            setMsg "使用羽毛传送"
            ret1 = useItem("img\yumao.bmp", True)
            If ret1 Then 
                err1 = 0
                Delay 500 + myRnd(500)
                setMsg "前往boss面前 10, 4"
                ret1 = walkTo("洗礼的试炼", 10, 4, 0, "")
                If ret1 Then 
                    err2 = 0
                    setMsg "确认战斗"
                    ret1 = fight(NORTH, True, True)
                    If False = ret1 Then 
                    	setMsg "进入战斗失败"
                        fightErr = fightErr + 1
                    Else 
                    	setMsg "开始战斗"
                        fightErr = 0
                    End If
                Else
                    setMsg "地图出错，重试"
                    Delay 2000 + myRnd(1000) 
                    err2 = err2 + 1
                End If
            Else
                setMsg "使用羽毛传送出错，重试"
                Delay 2000 + myRnd(1000)
                err1 = err1 + 1
            End If
        Else 
            setMsg "战斗中..."
            Delay 2000 + myRnd(2000)
        End If
    Loop
End Function

Function zhuansheng5()
    Dim free, ret1, fightErr, err1, err2
    fightErr = 0
    err1 = 0
    err2 = 0
    Do While S_RUN = isRun
        If fightErr > 1 Or err1 > 3 Or err2 > 3 Then
            setMsg "错误次数过多，停止执行"
            Exit Do
        End If
        free = isFree()
        If free Then 
            setMsg "前往竞技场 247, 91"
            ret1 = walkTo("法兰城", 247, 91, 0, "竞技场")
            If ret1 Then 
                err1 = 0
                setMsg "前往boss面前 34, 37"
                ret1 = walkTo("竞技场", 34, 37, 0, "")
                If ret1 Then 
                    err2 = 0
                    setMsg "确认战斗"
                    ret1 = fight(NORTH, True, True)
                    If False = ret1 Then 
                    	setMsg "进入战斗失败"
                        fightErr = fightErr + 1
                    Else 
                    	setMsg "开始战斗"
                        fightErr = 0
                    End If
                Else
                    setMsg "地图出错，回城"
                    goHome 
                    err2 = err2 + 1
                End If
            Else
                setMsg "地图出错，回城"
                goHome 
                err1 = err1 + 1
            End If
        Else 
            setMsg "战斗中..."
            Delay 2000 + myRnd(2000)
        End If
    Loop
End Function

Function useAllItem(picName)
    Dim free, ret1, err1
    fightErr = 0
    err1 = 0
    Do While S_RUN = isRun
        If err1 > 3 Then
            setMsg "错误次数过多，停止执行"
            Exit Do
        End If
        free = isFree()
        If free Then 
            setMsg "开始使用物品"
            ret1 = useItem(picName, True)
            If ret1 Then 
                err1 = 0
                setMsg "使用成功，继续"
                Delay 500 + myRnd(500)
            Else
                setMsg "使用出错，重试"
                Delay 2000 + myRnd(1000)
                err1 = err1 + 1
            End If
        Else 
            setMsg "战斗中,无法使用物品"
            Exit Do
        End If
    Loop
End Function

Function zhiliao()
	Dim i, ret1, tmp, index,mapPos


	ret1 = walkTo("竞技场", 42, 37, 0, "")
	faceTo EAST
	Delay 1000 + myRnd(1000)
	zhiliao = False
	tmp = getDialog(197,252,291,277)
	index = Instr(tmp, "治")
	If index > 0 Then 
		lineMove 200 + myRnd(200), 260 + myRnd(5), NORMAL_SPEED * 2
		Delay 600 + myRnd(300)
		dm.LeftClick
		Delay 1000 + myRnd(500)
		clickConfirm (True)
		Delay 1000 + myRnd(500)
		zhiliao = True
	End If
	clickCancel
	setMsg "结束治疗"
End Function


Function huiFu()
	Dim tmp, index
	
	ret1 = walkTo("竞技场", 43, 36, 0, "")
	faceTo NORTH
	Delay 1000 + myRnd(500)

	setMsg "开始回复"
	tmp = getDialog(262, 138, 399, 167)
	index = Instr(tmp, "回复")
	huiFu = False
	If index > 0 Then 
		lineMove 207 + myRnd(200), 191 + myRnd(5), NORMAL_SPEED * 2
		Delay 600 + myRnd(300)
		dm.LeftClick
		Delay 800 + myRnd(800)
		clickConfirm (True)
		Delay 800 + myRnd(800)
		huiFu = True
	Else 
		Exit Function
	End If
	
	tmp = getDialog(262, 138, 399, 167)
	index = Instr(tmp, "回复")
	huiFu = False
	If index > 0 Then 
		lineMove 265 + myRnd(100), 231 + myRnd(5), NORMAL_SPEED * 2
		Delay 600 + myRnd(300)
		dm.LeftClick
		Delay 800 + myRnd(800)
		clickConfirm (True)
		Delay 800 + myRnd(800)
		huiFu = True
	End If
	huiFu = False
	tmp = getDialog(262, 138, 399, 167)
	index = Instr(tmp, "回复")
	If index > 0 Then 
		lineMove 221 + myRnd(100), 271 + myRnd(5), NORMAL_SPEED * 2
		Delay 600 + myRnd(300)
		dm.LeftClick
		Delay 800 + myRnd(800)
		clickConfirm (True)
		Delay 800 + myRnd(800)
		huiFu = True
	End If
	clickCancel

End Function

Function staticFight(isYes)
    Dim free, ret1, fightErr, err1, err2, rndClick, mapPos, mapName, tmpPos
    fightErr = 0
    rndClick = 0
    isLeader = False
    isTeam = True
    Delay 3000 * wndIndex
    
    mapPos = getGamePos()
    mapName = getGameMap()
    ret1 = walkTo(mapName, mapPos(0) + 1, mapPos(1), 0, "")
    exeStatus = exeStatus And ((2 ^ WND_NUM - 1) Xor (2 ^ wndIndex))

    If ret1 Then 
    	isLeader = True
    	setMsg "我是队长"
    	Do While exeStatus > 0
		 	Delay 500 + myRnd(500)
		Loop
    Else 
    	setMsg "我是队员"
    End If
    
    If "竞技场" = mapName And mapPos(1) > 46 Then 
		teamStatus = teamStatus Or (2 ^ wndIndex)
    End If
    
    Do While S_RUN = isRun
    	If fightErr > 3 Then
        	setMsg "错误次数过多，停止执行"
        	Exit Do
        End If
        free = isFree()
    	If isLeader Then 
        	If free Then 
        		Delay 2000 +  myRnd(1000)
        		If "竞技场" = mapName And mapPos(1) > 46 Then 
        			breakTeam
        			If Not zhiliao  Then 
        				zhiliao
        			End If
        			If Not huiFu  Then 
        				huiFu
        			End If
        			Do While (Not createTeam("竞技场", 39, 40, EAST)) 
        				Delay 1000 + myRnd(1000)
            		Loop
        		End If
        		tmpPos = getDirectGamePos(myRnd(8) + 1, 1)
   				ret1 = walkTo(mapName, tmpPos(0), tmpPos(1), 0, "")
   				Delay 500 + myRnd(500)
        		ret1 = walkTo(mapName, mapPos(0), mapPos(1), 0, "")
            	setMsg "确认进入战斗"
    			Delay 500 + myRnd(100)
            	ret1 = fight(NORTH, True, isYes)
            	If False = ret1 Then 
            		setMsg "进入战斗失败"
                	fightErr = fightErr + 1
                	Delay 1000 + myRnd(1000)
            	Else 
            		setMsg "开始战斗"
                	fightErr = 0
            	End If
        	Else
        		fightErr = 0
            	setMsg "战斗中..."
            	rndClick = rndClick + 1
            	
            	If rndClick > (20 + myRnd(30)) Then 
            		lineMove 50 + myRnd(500), 50 + myRnd(300), NORMAL_SPEED
            		rndClick = 0
            	End If
            	dm.EnableBind 0
        		Delay 5000 + myRnd(5000)
        		dm.EnableBind 1
        	End If
        Else 
       		If free Then 
       			If Not isTeam  Then 
        			setMsg "队伍解散，开始干活"
        			If Not zhiliao  Then 
        				zhiliao
        			End If
        			If Not huiFu  Then 
        				huiFu
        			End If 
        			ret1 = True
        			Do While (Not createTeam("竞技场", 39, 40, EAST)) 
        				Delay 1000 + myRnd(1000)
            		Loop
            		Do While True
						If currentTeamStatus = teamStatus Then 
							setMsg "队伍集结完毕"
							Delay 1000 + myRnd(1000)
							Exit Do
						End If
						setMsg "等待其他队友归队"
		 				Delay 500 + myRnd(500)
					Loop
        		End If
        		setMsg "组队中，无操作"
        		dm.EnableBind 0
        		Delay 2000 + myRnd(2000)
        		dm.EnableBind 1
       		Else
        		fightErr = 0
            	setMsg "战斗中..."
            	rndClick = rndClick + 1
            	
            	If rndClick > (20 + myRnd(30)) Then 
            		lineMove 50 + myRnd(500), 50 + myRnd(300), NORMAL_SPEED
            		rndClick = 0
            	End If
            	dm.EnableBind 0
        		Delay 5000 + myRnd(5000)
        		dm.EnableBind 1
        	End If
        End If
    Loop
End Function

Function bairen()
	Dim free, ret1, fightErr, err1, err2
    fightErr = 0
    err1 = 0
    err2 = 0
    Do While S_RUN = isRun
        If fightErr > 1 Or err1 > 3 Or err2 > 3 Then
            setMsg "错误次数过多，停止执行"
            Exit Do
        End If
        free = isFree()
        If free Then
            setMsg "使用镜子传送传送"
            ret1 = useItem("img\jingzi.bmp", True)
            If ret1 Then
                err1 = 0
                Delay 500 + myRnd(500)
                setMsg "前往boss面前 23, 16"
                ret1 = walkTo("最终道场", 38, 10, 0, "")
                If ret1 Then 
                    err2 = 0
                    setMsg "确认战斗"
                    ret1 = fight(EAST_NORTH, True, True)
                    If False = ret1 Then 
                    	setMsg "进入战斗失败"
                        fightErr = fightErr + 1
                    Else 
                    	setMsg "开始战斗"
                        fightErr = 0
                    End If
                Else
                    setMsg "地图出错，重试"
                    Delay 2000 + myRnd(1000) 
                    err2 = err2 + 1
                End If
            Else
                setMsg "使用镜子传送传送出错，重试"
                Delay 2000 + myRnd(1000)
                err1 = err1 + 1
            End If
        Else 
            setMsg "战斗中..."
            Delay 2000 + myRnd(2000)
        End If
    Loop
End Function

Function minDiff(min)
	Dim m
	If min < 0 Then 
		minDiff = 0
		Exit Function
	End If
	
	m = Minute(Now)
	If min + 1 > m Then 
		minDiff = 60 - min - 1 + m
		Exit Function
	End If
	
	minDiff = m - min - 1
End Function

Function goYifei1()
	Dim curPos, ret1, posLen, mapName
	
	log "goYifei1"
	goYifei1 = True
	mapName = getGameMap()
	curPos = getGamePos()
	ret1 = False
	If mapName = "莎莲娜" And curPos(0) > 300 Then 
		ret1 = findNPC("限时亦菲", True)	
	End If
	
	If not ret1 Then 
		ret1 = goHome
		If ret1 Then 
			Delay 1000 + myRnd(500)
			ret1 = walkTo("法兰城", 245, 81, 0, "")
		End If
		If ret1  Then 
			ret1 = walkTo("法兰城", 247, 81, 0, "万能传送大厅")
		End If
		If ret1  Then
			ret1 = walkTo("万能传送大厅", 34, 25, 0, "")
		End If
		If ret1  Then 
			ret1 = walkTo("万能传送大厅", 36, 17, 0, "")
		End If
		If ret1  Then 
			ret1 = walkTo("万能传送大厅", 38, 15, 0, "")
		End If
		If ret1 Then 
			faceTo NORTH
			Delay 500 + myRnd(200)
			ret1 = clickConfirm(True)
		End If
		If ret1 Then 
			Delay 1000 + myRnd(500)
			ret1 = walkTo("杰诺瓦镇传送之间", 9, 9, 0, "")
		End If
		If ret1 Then 
			ret1 = walkTo("杰诺瓦镇传送之间", 14, 6, 0, "村长的家")
		End If
		If ret1 Then 
			ret1 = walkTo("村长的家", 13, 9, 0, "")
		End If
		If ret1 Then 
			ret1 = walkTo("村长的家", 1, 10, 0, "杰诺瓦镇")
		End If
		If ret1 Then 
			ret1 = walkTo("杰诺瓦镇", 52, 35, 0, "")
		End If
		If ret1 Then 
			ret1 = walkTo("杰诺瓦镇", 63, 29, 0, "")
		End If
		If ret1 Then 
			ret1 = walkTo("杰诺瓦镇", 71, 18, 0, "莎莲娜")
		End If
		If ret1 Then 
			ret1 = walkTo("莎莲娜", 283, 416, 0, "")
		End If
		If ret1 Then 
			ret1 = walkTo("莎莲娜", 293, 416, 0, "")
		End If
		If ret1 Then 
			ret1 = walkTo("莎莲娜", 296, 427, 0, "")
		End If
		If ret1 Then 
			ret1 = walkTo("莎莲娜", 315, 426, 0, "")
		End If
		If ret1 Then 
			ret1 = walkTo("莎莲娜", 317, 440, 0, "")
		End If
		If ret1 Then 
			ret1 = walkTo("莎莲娜", 328, 452, 0, "")
		End If
		If ret1 Then 
			ret1 = walkTo("莎莲娜", 342, 464, 0, "")
		End If
		If ret1 Then 
			ret1 = walkTo("莎莲娜", 342, 464, 0, "")
		End If
		If ret1 Then 
			ret1 = walkTo("莎莲娜", 343, 472, 0, "")
		End If
		If ret1 Then 
			ret1 = walkTo("莎莲娜", 339, 475, 0, "")
		End If
		If ret1 Then 
			ret1 = findNPC("限时亦菲", True)
		End If
		If ret1 Then 
			setMsg "已经到达亦菲面前"
		Else 
			goYifei1 = False
			setMsg "前往亦菲出错，等待重试"
			Exit Function
		End If
	Else 
		setMsg "已经到达亦菲面前"
	End If
	
	posLen = Len(dm.FindColorEx(263,151,307,170,"1e3ec7-000000|2042db-000000|1e3bbe-000000|1e47e5-000000|2d59be-000000|2b53af-000000|2b488f-000000|2d6ae5-000000|2d5dc7-000000|2b4e9d-000000",0.99,0))
	log "亦菲识别-" & posLen
	If posLen < 100 Then
		setMsg "亦菲还没刷新，等待中"
		Exit Function
	End If
	dm.KeyPressChar "/"
    Delay 100 + myRnd(100)
    dm.KeyPressChar "a"
    Delay 200 + myRnd(100)
    dm.KeyPressChar "enter"
    Delay 100 + myRnd(100)
	yifei1 = Clng(dm.GetTime() / 1000) + 3600
	ret1 = fight(WEST, True, True)
	If ret1 Then 
		Delay 20000	
	End If
	dm.KeyPressChar "/"
    Delay 100 + myRnd(100)
    dm.KeyPressChar "a"
    Delay 200 + myRnd(100)
    dm.KeyPressChar "enter"
    Delay 100 + myRnd(100)
	If ret1 Then 
		setMsg "进入战斗，干起来"
	Else 
		setMsg "进入战斗失败，等待重试"
	End If
End Function

Function goYifei2()
	Dim curPos, ret1, posLen, mapName
	
	log "goYifei2"
	goYifei2 = True
	mapName = getGameMap()
	curPos = getGamePos()
	ret1 = False
	If mapName = "莎莲娜" And curPos(0) < 100 Then 
		ret1 = findNPC("限时亦菲", True)	
	End If
	If not ret1 Then 
		ret1 = goHome
		If ret1 Then 
			Delay 1000 + myRnd(500)
			ret1 = walkTo("法兰城", 245, 81, 0, "")
		End If
		If ret1  Then 
			ret1 = walkTo("法兰城", 247, 81, 0, "万能传送大厅")
		End If
		If ret1  Then
			ret1 = walkTo("万能传送大厅", 34, 25, 0, "")
		End If
		If ret1  Then 
			ret1 = walkTo("万能传送大厅", 38, 21, 0, "")
		End If
		If ret1 Then 
			faceTo NORTH
			Delay 500 + myRnd(200)
			ret1 = clickConfirm(True)
		End If
		If ret1 Then 
			Delay 1000 + myRnd(500)
			ret1 = walkTo("魔法大学", 75, 172, 0, "莎莲娜")
		End If
		If ret1 Then 
			ret1 = walkTo("莎莲娜", 108, 129, 0, "")
		End If
		If ret1 Then 
			ret1 = walkTo("莎莲娜", 103, 135, 0, "")
		End If
		If ret1 Then 
			ret1 = walkTo("莎莲娜", 89, 149, 0, "")
		End If
		If ret1 Then 
			ret1 = walkTo("莎莲娜", 63, 166, 0, "")
		End If
		If ret1 Then 
			ret1 = walkTo("莎莲娜", 63, 175, 0, "")
		End If
		If ret1 Then 
			ret1 = walkTo("莎莲娜", 47, 175, 0, "")
		End If
		If ret1 Then 
			ret1 = findNPC("限时亦菲", True)
		End If
		If ret1 Then 
			setMsg "已经到达亦菲面前"
		Else 
			goYifei2 = False
			setMsg "前往亦菲出错，等待重试"
			Exit Function
		End If
	Else 
		setMsg "已经到达亦菲面前"
	End If
	posLen = Len(dm.FindColorEx(263,151,307,170,"1e3ec7-000000|2042db-000000|1e3bbe-000000|1e47e5-000000|2d59be-000000|2b53af-000000|2b488f-000000|2d6ae5-000000|2d5dc7-000000|2b4e9d-000000",0.99,0))
	log "亦菲识别-" & posLen
	If posLen < 100 Then 
		setMsg "亦菲还没刷新，等待中"
		Exit Function
	End If
	yifei2 = Clng(dm.GetTime() / 1000) + 3600
	dm.KeyPressChar "/"
    Delay 100 + myRnd(100)
    dm.KeyPressChar "a"
    Delay 200 + myRnd(100)
    dm.KeyPressChar "enter"
    Delay 100 + myRnd(100)
	ret1 = fight(WEST, True, True)
	If ret1 Then 
		Delay 20000	
	End If
	dm.KeyPressChar "/"
    Delay 100 + myRnd(100)
    dm.KeyPressChar "a"
    Delay 200 + myRnd(100)
    dm.KeyPressChar "enter"
    Delay 100 + myRnd(100)
	If ret1 Then 
		setMsg "进入战斗，干起来"
	Else 
		setMsg "进入战斗失败，等待重试"
	End If
End Function

Function yifei()
    Dim ret1, free, diff1, diff2, err1, curSec, isBreak1, isBreak2
    yifei1 = Clng(dm.GetTime() / 1000)
    yifei2 = yifei1
    err1 = 0
    isBreak1 = False
    isBreak2 = False
    Do While S_RUN = isRun
        If err1 > 6 Then 
            setMsg "出错次数过多，停止执行"
            Exit Do
        End If
        free = isFree()
        If free Then 
        	curSec = Clng(dm.GetTime() / 1000)
            diff1 = yifei1 - curSec
            diff2 = yifei2 - curSec
            If isBreak1 Then 
            	diff2 = diff1 -1
            End If
            If isBreak2 Then 
            	diff1 = diff2 -1
            End If
            If diff2 < diff1 Then 
                ret1 = goYifei2()
                If (curSec - yifei2) > 4200 Then 
                	isBreak2 = True
                	yifei1 = curSec
                End If 
            Else 
                ret1 = goYifei1()
                If (curSec - yifei1) > 4200 Then 
                	isBreak1 = True
                	yifei2 = curSec
                End If 
            End If
            If isBreak1 And isBreak2 Then 
            	isBreak1 = False
    			isBreak2 = False
            End If
            If (diff1 > 30) And (diff2 > 30) Then
                setMsg "时间还早，原地休息"
                Delay 10000 + myRnd(10000)
            End If
            
            setMsg "原地休息"
            Delay 1000 + myRnd(2000)
            If ret1 Then 
            	err1 = 0
            Else 
            	err1 = err1 + 1
            End If
        Else 
            setMsg "战斗中..."
            Delay 2000 + myRnd(2000)	
        End If
    Loop
End Function

Function executeTask()
    Dim hwnd, ret1, sRect, arr, wndX, wndY
    wndIndex = currentIndex
    hwnd = currentHwnd
    wndStatus = wndStatus Or (2 ^ wndIndex)
    initDm
    'dm1.BindWindowEx(hwnd, "dx", "windows", "windows", "dx.public.anti.api", 6)
    ret1 = dm.BindWindow(hwnd, "gdi", "windows", "windows", 0)
    If ret1 = 0 Then
        setMsg "绑定窗口" & hwnd & "失败，退出执行任务"
        wndStatus = wndStatus And ((2 ^ WND_NUM - 1) Xor (2 ^ wndIndex))
        Exit Function	
    End If
    dm1.DownCpu 80
    fileName = "log\wnd" & wndIndex + 1 & ".log"
	dm.DeleteFile  fileName
    setMsg "启动线程，绑定窗口，开始执行任务"
    If TASK_ZHUAN_3 = taskType Then 
        ret1 = zhuansheng3()
    ELSEIf TASK_ZHUAN_4 = taskType Then 
        ret1 = zhuansheng4()
    ELSEIf TASK_ZHUAN_5 = taskType Then 
        ret1 = zhuansheng5()
    ELSEIf TASK_EGG = taskType Then 
        ret1 = useAllItem("img\egg.bmp")
    ElseIf TASK_YES_FIGHT = taskType Then
        ret1 = staticFight(True)
    ElseIf TASK_NO_FIGHT = taskType Then
        ret1 = staticFight(False)
    ElseIf TASK_JINGYAN = taskType Then
        ret1 = useAllItem("img\jingyan.bmp")
    ElseIf TASK_BAI_REN = taskType Then
        ret1 = bairen()
    ElseIf TASK_YI_FEI = taskType Then
        ret1 = yifei()
    End If
    dm1.UnBindWindow
    wndStatus = wndStatus And ((2 ^ WND_NUM - 1) Xor (2 ^ wndIndex))
End Function

Function startTask()
    Dim i, start, current, threadIds(5)
    start = Now
    currentIndex = 0
    wndStatus = 0
    msg1 = ""
    msg2 = ""
    msg3 = ""
    msg4 = ""
    msg5 = ""
    msg6 = ""
    statsMsg = ""
	exeStatus = selectWnds
    For i = 0 To WND_NUM
        threadIds(i) = 0
        currentIndex = i
        currentHwnd = hwndArr(i)
        If (selectWnds And (2 ^ i)) > 0 Then 
            threadIds(i) = BeginThread(executeTask)
            Do While (wndStatus And (2 ^ i)) > 0
                Delay 50
            Loop
            Delay 100
        End If
    Next
    Do  While (wndStatus > 0)
        current = Now
        statusMsg = operateName & " 当前状态：运行中 开始时间：" & start & " 当前时间：" & current
        Delay 1000
    Loop
    For i = 0 To WND_NUM
        If threadIds(i) > 0 Then
            StopThread threadIds(i)
            threadIds(i) = 0
        End If
    Next
    current =Now
    statusMsg = operateName & " 当前状态：已结束 开始时间：" & start & " 结束时间：" & current
End Function

Function clickConfirm(isYes)
    Dim ret1
    lineMove 138 + myRnd(300), 56 + myRnd(50), NORMAL_SPEED
    If isYes Then 
        ret1 = findMyPic(100,171,542,368, "img\yes.bmp", True)
        If Not ret1 Then 
        	ret1 = findMyPic(100,171,542,368, "img\confirm.bmp", True)
        End If
    Else 
        ret1 = findMyPic(100,171,542,368, "img\no.bmp", True)
        If Not ret1 Then 
        	ret1 = findMyPic(100,171,542,368, "img\confirm.bmp", True)
        End If
    End If
    If Not ret1 Then 
        clickConfirm = False
        Exit Function
    End If
    
    Delay myRnd(200) + 200
    dm.LeftClick 
    Delay myRnd(200) + 1000
    ret1 = findMyPic(199, 298, 450, 368, "img\confirm.bmp", True)
    If ret1 Then 
        dm.LeftClick
    End If
    clickConfirm = True
End Function

Function clickCancel()
    Dim ret1
    lineMove 138 + myRnd(300), 56 + myRnd(50), NORMAL_SPEED
    clickCancel = False
    ret1 = findMyPic(199, 298, 450, 368, "img\cancel.bmp", True)
    If ret1 Then 
        dm.LeftClick
    End If
    clickCancel = True
End Function

Function getGamePos()
    Dim pos(2), tmp1, tmp2
    dm.UseDict 0
    tmp1 = dm.Ocr(476, 50, 559, 100, "ffffff-000000|fefefe-000000|fdfdfd-000000|fcfcfc-000000|fbfbfb-000000|fafafa-000000|f9f9f9-000000|f8f8f8-000000|f7f7f7-000000|f6f6f6-000000", 0.95)
    If tmp1 <> "" Then 
        tmp2 = dm.Ocr(582, 50, 639, 100, "ffffff-000000|fefefe-000000|fdfdfd-000000|fcfcfc-000000|fbfbfb-000000|fafafa-000000|f9f9f9-000000|f8f8f8-000000|f7f7f7-000000|f6f6f6-000000", 0.95)
        If tmp2 <> "" Then 
            pos(0) = Clng(tmp1)
            pos(1) = Clng(tmp2)
            log "识别地图 " & pos(0) & "," & pos(1)
            getGamePos = pos
            Exit Function
        End If
    End If
    getGamePos = pos
End Function
Function getGameMap()
    dm.UseDict 1
    getGameMap = dm.Ocr(487,172,625,214, "ffffff-000000|fefefe-000000|fdfdfd-000000|fcfcfc-000000|fbfbfb-000000|fafafa-000000|f9f9f9-000000|f8f8f8-000000|f7f7f7-000000|f6f6f6-000000", 0.95)
End Function
Function getDialog(x1, y1, x2, y2)
    dm.UseDict 2
    lineMove 138 + myRnd(300), 56 + myRnd(50), NORMAL_SPEED
    getDialog = dm.Ocr(x1, y1, x2, y2, "ffffff-000000", 0.95)
End Function

Function findNPC(name, isMove)
	Dim i, findNum, curFind, tmp, pos(2), arr1, arr2, arr3, index, count
    dm.UseDict 3
    
    findNPC = False
    tmp = dm.OcrEx(2, 66, 542, 371, "ffffff-000000", 0.95)
    TracePrint tmp
    If Len(tmp) <= 0 Then
		Exit Function
    End If
    
    arr1 = split(tmp, "|")
    count = Len(name)
    findNum = 0
    curFind = 0
    For i = 1 To count
    	index = Instr(arr1(0), Mid(name, i, 1))
    	If (index > 0) Then 
    		If curFind > i Then 
    			findNPC = False
    			Exit For
    		End If
    		curFind = i 
    		findNum = findNum + 1
    		arr2 = split(arr1(index), ",")
    		pos(0) = Clng(arr2(0))  + (Clng(count / 2) - i) * 14 + 32 + myRnd(16)
        	pos(1) = Clng(arr2(1)) + 72 - myRnd(12)
        	If findNum > 1 Then
        		findNPC = True
        	End If
    	End If
    Next
    If findNPC And isMove Then 
    	If (pos(0) < 285) Or (pos(0) > 350) Or (pos(1) < 215) Or (pos(1) > 260) Then 
    		lineMove pos(0), pos(1), NORMAL_SPEED * 2
    		dm.LeftClick
    	End If
    End If
End Function

Function useItem(itemPic, needConfirm)
    Dim ret
    lineMove myRnd(300) + 100, myRnd(50) + 405, 5
    ret = dm.FindColor(176,468,177,469,"aaa69d-000000",0.99,0,intX,intY)
    If 0 = ret Then
        dm.KeyDownChar "Ctrl"
        Delay myRnd(100) + 200
        dm.KeyPressChar "E"
        Delay myRnd(200) + 100
        dm.KeyUpChar "Ctrl"
        Delay myRnd(300) + 300
        dm.KeyPressChar "back"
        Delay myRnd(500) + 500
    End If
    ret = findMyPic(151, 95, 626, 400, itemPic, True)
    If False = ret Then 
        useItem = False
        Exit Function
    End If
    useItem = True
    Delay myRnd(200) + 100
    dm.LeftDoubleClick 
    If needConfirm Then 
        Delay myRnd(300) + 600
        useItem = clickConfirm(True)
    End If
End Function

Function getDirectGamePos(direct, steps)
	Dim mapPos
	Dim posArr(2)
    
    mapPos = getGamePos
    
    If direct = EAST Then
        posArr(0) = mapPos(0) + steps
        posArr(1) = mapPos(1)
    ElseIf direct = WEST Then
        posArr(0) = mapPos(0) - steps
        posArr(1) = mapPos(1)
    ElseIf direct = SOUTH Then
        posArr(0) = mapPos(0)
        posArr(1) = mapPos(1) + steps
    ElseIf direct = NORTH Then
        posArr(0) = mapPos(0)
        posArr(1) = mapPos(1) - steps
    ElseIf direct = EAST_SOUTH Then
        posArr(0) = mapPos(0) + steps
        posArr(1) = mapPos(1) + steps
    ElseIf direct = EAST_NORTH Then
        posArr(0) = mapPos(0) + steps
        posArr(1) = mapPos(1) - steps
    ElseIf direct = WEST_SOUTH Then
        posArr(0) = mapPos(0) - steps
        posArr(1) = mapPos(1) + steps
    ElseIf direct = WEST_NORTH Then
        posArr(0) = mapPos(0) - steps
        posArr(1) = mapPos(1) - steps
    End If
    getDirectGamePos = posArr
End Function

Function getDirectPos(direct, steps)
	Dim posX, posY, stepX, stepY
	Dim posArr(2)
    posX = 305
    posY = 228
    stepX = 32
    stepY = 24
    
    If direct = EAST Then
        posArr(0) = posX + stepX * steps
        posArr(1) = posY - stepY * steps
    ElseIf direct = WEST Then
        posArr(0) = posX - stepX * steps
        posArr(1) = posY + stepY * steps
    ElseIf direct = SOUTH Then
        posArr(0) = posX + stepX * steps
        posArr(1) = posY + stepY * steps
    ElseIf direct = NORTH Then
        posArr(0) = posX - stepX * steps
        posArr(1) = posY - stepY * steps
    ElseIf direct = EAST_SOUTH Then
        posArr(0) = posX + stepX * 2 * steps
        posArr(1) = posY
    ElseIf direct = EAST_NORTH Then
        posArr(0) = posX
        posArr(1) = posY - stepY * 2 * steps
    ElseIf direct = WEST_SOUTH Then
        posArr(0) = posX
        posArr(1) = posY + stepY * 2 * steps
    ElseIf direct = WEST_NORTH Then
        posArr(0) = posX - stepX * 2 * steps
        posArr(1) = posY
    End If
    getDirectPos = posArr
End Function

Function faceTo(direct)
    Dim clickPos
    clickPos = getDirectPos(direct, ((myRnd(20) Mod 3) + 1))
    lineMove clickPos(0) + myRnd(Clng(32 * 0.8)), clickPos(1) + myRnd(Clng(24 * 0.8)), NORMAL_SPEED
    dm.RightClick
End Function

Function walkTo(curMapName, mapX, mapY, direct, newMapName)
    Dim distanceX, distanceY, mapPos
    Dim plan(4), steps, clickPos, mapName
    Dim posX, posY, stepX, stepY, startX, startY
    Dim i,j,k,lastDirect
    walkTo = False
    
    setMsg "前往" & curMapName & " (" & mapX & "," & mapY & ")"
    For i = 0 To 4
        mapPos = getGamePos
        mapName = getGameMap()
        log "game pos:" & mapName &" " & mapPos(0) & ","& mapPos(1)
        If curMapName <> mapName Then 
        	log("地图不匹配")
            Exit For
        End If
        If mapPos(0) < 1 Or mapPos(1) < 1 Then 
        	log("无法识别坐标")
            walkTo = False
            Exit For
        End If
        distanceX = mapX - mapPos(0)
        distanceY = mapY - mapPos(1)
        plan(2) = 0
        plan(3) = 0
        If 0 = distanceX Then
            If distanceY > 0 Then
                plan(0) = SOUTH
                plan(1) = distanceY
            Else
                plan(0) = NORTH
                plan(1) = 0 - distanceY
            End If
        ElseIf 0 = distanceY Then
            If distanceX > 0 Then
                plan(0) = EAST
                plan(1) = distanceX
            Else
                plan(0) = WEST
                plan(1) = 0 - distanceX
            End If
        ElseIf distanceX > 0 And distanceY > 0 Then
            plan(0) = EAST_SOUTH
            If distanceY > distanceX Then
                plan(1) = distanceX
                plan(2) = SOUTH
                plan(3) = distanceY - distanceX
            Else
                plan(1) = distanceY
                plan(2) = EAST
                plan(3) = distanceX - distanceY
            End If
        ElseIf distanceX > 0 And distanceY < 0 Then
            distanceY = 0 - distanceY
            plan(0) = EAST_NORTH
            If distanceY > distanceX Then
                plan(1) = distanceX
                plan(2) = NORTH
                plan(3) = distanceY - distanceX
            Else
                plan(1) = distanceY
                plan(2) = EAST
                plan(3) = distanceX - distanceY
            End If
        ElseIf distanceX < 0 And distanceY > 0 Then
            distanceX = 0 - distanceX
            plan(0) = WEST_SOUTH
            If distanceY > distanceX Then
                plan(1) = distanceX
                plan(2) = SOUTH
                plan(3) = distanceY - distanceX
            Else
                plan(1) = distanceY
                plan(2) = WEST
                plan(3) = distanceX - distanceY
            End If
        ElseIf distanceX < 0 And distanceY < 0 Then
            distanceX = 0 - distanceX
            distanceY = 0 - distanceY
            plan(0) = WEST_NORTH
            If distanceY > distanceX Then
                plan(1) = distanceX
                plan(2) = NORTH
                plan(3) = distanceY - distanceX
            Else
                plan(1) = distanceY
                plan(2) = WEST
                plan(3) = distanceX - distanceY
            End If
        End If
        log "plan" & plan(0) &"," & plan(1) & " "& plan(2)  &"," & plan(3)
        steps = plan(1) + plan(3)
        For j = 1 To steps
            If isRun <> S_RUN Then 
                Exit Function
            End If
            isTwo = False
            If (myRnd(10) Mod 2) = 1 Then
                If plan(1) > 0 Then
                    clickPos = getDirectPos(plan(0), 1)
                    lineMove clickPos(0) + myRnd(Clng(32 * 0.6)), clickPos(1) + myRnd(Clng(24 * 0.6)), NORMAL_SPEED
                    plan(1) = plan(1) - 1
                    lastDirect = plan(0)
                Else
                    clickPos = getDirectPos(plan(2), 1)
                    lineMove clickPos(0) + myRnd(Clng(32 * 0.6)), clickPos(1) + myRnd(Clng(24 * 0.6)), NORMAL_SPEED
                    plan(3) = plan(3) - 1
                    lastDirect = plan(2)
                End If
            Else
                If plan(3) > 0 Then
                    clickPos = getDirectPos(plan(2), 1)
                    lineMove clickPos(0) + myRnd(Clng(32 * 0.6)), clickPos(1) + myRnd(Clng(24 * 0.6)), NORMAL_SPEED
                    lastDirect = plan(2)
                Else
                    clickPos = getDirectPos(plan(0), 1)
                    lineMove clickPos(0) + myRnd(Clng(32 * 0.6)), clickPos(1) + myRnd(Clng(24 * 0.6)), NORMAL_SPEED
                    plan(1) = plan(1) - 1
                    lastDirect = plan(0)
                End If
            End If
            Delay 50 + myRnd(20)
            dm.LeftClick 
            If lastDirect > NORTH Then 
            	Delay 350 + myRnd(100)
            Else 
            	Delay 150 + myRnd(100)
            End If
            
        Next
        If "" = newMapName Then 
            Delay 250 + myRnd(100)
            mapPos = getGamePos
            log "pos:" & mapPos(0) & ","& mapPos(1)
            If mapPos(0) = mapX And mapPos(1) = mapY Then 
                walkTo = True
                Exit For
            End If
        Else 
        	Delay 550 + myRnd(200)
            For k = 1 To 3
                mapName = getGameMap()
                log "map:" & mapName
                If "" <> mapName Then 
                    Exit For
                End If
                Delay 550 + myRnd(200)
            Next
            If newMapName = mapName Then
                walkTo = True
                Exit For
            End If
        End If
    Next
    If direct > 0 AND walkTo Then 
        faceTo direct
    End If
End Function
Function myRnd(num)
    Randomize
    myRnd = Clng(rnd() * num)
End Function
Function bt1Event()
    Dim start, current
    wndIndex = 0
    operateName = "刷新窗口"
    start = Now
    current = Now
    statusMsg = operateName & " 当前状态：进行中 开始时间：" & start & " 当前时间：" & current
    flushWnd
    current = Now
    statusMsg = operateName & " 当前状态：已结束 开始时间：" & start & " 结束时间：" & current
    isRun = S_STOP
End Function
Event p1.bt1.Click
    If 0 = eventThreadId Then 
        eventThreadId = BeginThread(eventRun)
    End If
    If isRun <> S_STOP Then 
        MsgBox "请先停止执行！"
        Exit Event
    End If
    disableControls 
    eventType = 1
    lastEventType = eventType
End Event
Function bt2Event()
    taskType = TASK_EGG
    operateName = "开10连蛋"
    startTask 
    isRun = S_STOP
End Function
Event p1.bt2.Click
    selectWnds = 0
    If isRun <> S_STOP Then 
        MsgBox "请先停止执行！"
        Exit Event
    End If
    initSelected 
    If 0 = selectWnds Then 
        MsgBox "请先选中窗口！" 
        Exit Event
    End If
    disableControls 
    eventType = 2
    lastEventType = eventType
End Event
Function bt3Event()
    taskType = TASK_YES_FIGHT
    operateName = "点是战斗"
    startTask 
    isRun = S_STOP
End Function
Event p1.bt3.Click
    selectWnds = 0
    If isRun <> S_STOP Then 
        MsgBox "请先停止执行！"
        Exit Event
    End If
    initSelected 
    If 0 = selectWnds Then 
        MsgBox "请先选中窗口！" 
        Exit Event
    End If
    disableControls 
    eventType = 3
    lastEventType = eventType
End Event

Function bt4Event()
    taskType = TASK_NO_FIGHT
    operateName = "点否战斗"
    startTask 
    isRun = S_STOP
End Function
Event p1.bt4.Click
    selectWnds = 0
    If isRun <> S_STOP Then 
        MsgBox "请先停止执行！"
        Exit Event
    End If
    initSelected 
    If 0 = selectWnds Then 
        MsgBox "请先选中窗口！" 
        Exit Event
    End If
    disableControls 
    eventType = 4
    lastEventType = eventType
End Event

Function bt5Event()
    taskType = TASK_JINGYAN
    operateName = "宠物经验"
    startTask 
    isRun = S_STOP
End Function
Event p1.bt5.Click
    selectWnds = 0
    If isRun <> S_STOP Then 
        MsgBox "请先停止执行！"
        Exit Event
    End If
    initSelected 
    If 0 = selectWnds Then 
        MsgBox "请先选中窗口！" 
        Exit Event
    End If
    disableControls 
    eventType = 5
    lastEventType = eventType
End Event

Function bt6Event()
    taskType = TASK_ZHUAN_3
    operateName = "3次转生"
    startTask 
    isRun = S_STOP
End Function
Event p1.bt6.Click
    selectWnds = 0
    If isRun <> S_STOP Then 
        MsgBox "请先停止执行！"
        Exit Event
    End If
    initSelected 
    If 0 = selectWnds Then 
        MsgBox "请先选中窗口！" 
        Exit Event
    End If
    disableControls 
    eventType = 6
    lastEventType = eventType
End Event

Function bt7Event()
    taskType = TASK_ZHUAN_4
    operateName = "4次转生"
    startTask 
    isRun = S_STOP
End Function
Event p1.bt7.Click
    selectWnds = 0
    If isRun <> S_STOP Then 
        MsgBox "请先停止执行！"
        Exit Event
    End If
    initSelected 
    If 0 = selectWnds Then 
        MsgBox "请先选中窗口！" 
        Exit Event
    End If
    disableControls 
    eventType = 7
    lastEventType = eventType
End Event

Function bt8Event()
    taskType = TASK_ZHUAN_5
    operateName = "刷转生5"
    startTask 
    isRun = S_STOP
End Function
Event p1.bt8.Click
    selectWnds = 0
    If isRun <> S_STOP Then 
        MsgBox "请先停止执行！"
        Exit Event
    End If
    initSelected 
    If 0 = selectWnds Then 
        MsgBox "请先选中窗口！" 
        Exit Event
    End If
    disableControls 
    eventType = 8
    lastEventType = eventType
End Event

Function bt9Event()
    taskType = TASK_BAI_REN
    operateName = "百人"
    startTask 
    isRun = S_STOP
End Function
Event p1.bt9.Click
    selectWnds = 0
    If isRun <> S_STOP Then 
        MsgBox "请先停止执行！"
        Exit Event
    End If
    initSelected 
    If 0 = selectWnds Then 
        MsgBox "请先选中窗口！" 
        Exit Event
    End If
    disableControls 
    eventType = 9
    lastEventType = eventType
End Event

Function bt10Event()
    taskType = TASK_YI_FEI
    operateName = "亦菲"
    startTask 
    isRun = S_STOP
End Function
Event p1.bt10.Click
    selectWnds = 0
    If isRun <> S_STOP Then 
        MsgBox "请先停止执行！"
        Exit Event
    End If
    initSelected 
    If 0 = selectWnds Then 
        MsgBox "请先选中窗口！" 
        Exit Event
    End If
    disableControls 
    eventType =10
    lastEventType = eventType
End Event

Function eventRun
    Dim tmpEventType
    init 
    initDm 
    Do While (isRun <> S_EXIT)
        tmpEventType = eventType
        If tmpEventType > 0 Then 
            p1.Timer1.Enabled = False
            p1.Timer1.Enabled = True
            eventType = 0
        End If
        If 0 = tmpEventType Then 
            Delay 1000
        ElseIf 1 = tmpEventType Then
            bt1Event
        ElseIf 2 = tmpEventType Then
            bt2Event
        ElseIf 3 = tmpEventType Then
            bt3Event
        ElseIf 4 = tmpEventType Then
            bt4Event
        ElseIf 5 = tmpEventType Then
            bt5Event
        ElseIf 6 = tmpEventType Then
            bt6Event
        ElseIf 7 = tmpEventType Then
            bt7Event
        ElseIf 8 = tmpEventType Then
            bt8Event 
        ElseIf 9 = tmpEventType Then
            bt9Event 
        ElseIf 10 = tmpEventType Then
            bt10Event
        End If
    Loop
End Function
Event p1.Load
    initEnv 
    p1.Timer1.Enabled = False
    p1.Timer1.Interval = 1000
    eventThreadId = 0
End Event
Event p1.UnLoad
    isRun = S_EXIT
    Delay 600
    If eventThreadId <> 0 Then 
        StopThread eventThreadId	
    End If
End Event
Event p1.stop.Click
    If isRun = S_RUN Then 
        isRun = S_WAIT
        p1.stop.Enabled = 0
    End If
End Event
Event p1.Timer1.Timer
    Dim current
    current = Now
    If p1.pLog.Caption <> statusMsg Then 
        p1.pLog.Caption = statusMsg
    End If
    If p1.msg1.Caption <> msg1 Then 
        p1.msg1.Caption = msg1
    End If
    If p1.msg2.Caption <> msg2 Then 
        p1.msg2.Caption = msg2
    End If
    If p1.msg3.Caption <> msg3 Then 
        p1.msg3.Caption = msg3
    End If
    If p1.msg4.Caption <> msg4 Then 
        p1.msg4.Caption = msg4
    End If
    If p1.msg5.Caption <> msg5 Then 
        p1.msg5.Caption = msg5
    End If
    If p1.msg6.Caption <> msg6 Then 
        p1.msg6.Caption = msg6
    End If
    If isRun = S_STOP Then 
        If 1 = lastEventType Then
            If "" <> wnd1Name Then 
                p1.wnd1.Caption = wnd1Name
                p1.wnd1.Visible = 1
                p1.wnd1.Enabled = 1
            Else
                p1.wnd1.Visible = 0
            End If
            If "" <> wnd2Name Then 
                p1.wnd2.Caption = wnd2Name
                p1.wnd2.Visible = 1
            Else
                p1.wnd2.Visible = 0
            End If
            If "" <> wnd3Name Then 
                p1.wnd3.Caption = wnd3Name
                p1.wnd3.Visible = 1
            Else
                p1.wnd3.Visible = 0
            End If
            If "" <> wnd4Name Then 
                p1.wnd4.Caption = wnd4Name
                p1.wnd4.Visible = 1
            Else
                p1.wnd4.Visible = 0
            End If
            If "" <> wnd5Name Then 
                p1.wnd5.Caption = wnd5Name
                p1.wnd5.Visible = 1
            Else
                p1.wnd5.Visible = 0
            End If
            If "" <> wnd6Name Then 
                p1.wnd6.Caption = wnd6Name
                p1.wnd6.Visible = 1
            Else
                p1.wnd6.Visible = 0
            End If
        End If
        p1.Timer1.Enabled = False
        lastEventType = 0
        enableControls 
        enableControls
    End If 
End Event

Dim hwnds
init

initEnv 
initDm 

hwnds = dm.EnumWindowByProcess("hjml.exe", "娃", "", 25)
arr = split(hwnds, ",")
If UBOUND(arr) > - 1  Then
    TracePrint hwnds
    hwnd = Clng(arr(0))
    'ret = dm.BindWindow(hwnd, "normal", "normal", "normal", 0)
    ret = dm.BindWindow(hwnd, "gdi", "windows", "windows", 0)
    isRun = S_RUN
    wndIndex = 1
    For i = 1 To 5
    	dm.KeyPressChar "space"
    Next
    dm.KeyPressChar "enter"

    dm.UnBindWindow 
End If