[General]
SyntaxVersion=2
BeginHotkey=119
BeginHotkeyMod=0
PauseHotkey=0
PauseHotkeyMod=0
StopHotkey=120
StopHotkeyMod=0
RunOnce=1
EnableWindow=
MacroID=580c7c71-bc04-4e84-9410-8757daf660d4
Description=hjml
Enable=0
AutoRun=0
[Repeat]
Type=0
Number=1
[SetupUI]
Type=1
QUI=p1
[Relative]
SetupOCXFile=
[Comment]
e

[UIPackage]
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


[Script]
Dimenv WND_NUM, NORMAL_SPEED, EAST, SOUTH, NORTH, WEST, EAST_SOUTH, EAST_NORTH, WEST_SOUTH, WEST_NORTH
DimEnv EAST_X, SOUTH_X, NORTH_X, WEST_X, EAST_SOUTH_X, EAST_NORTH_X, WEST_SOUTH_X, WEST_NORTH_X
DimEnv EAST_Y, SOUTH_Y, NORTH_Y, WEST_Y, EAST_SOUTH_Y, EAST_NORTH_Y, WEST_SOUTH_Y, WEST_NORTH_Y
DimEnv eventType, lastEventType, isRun, operateName
DimEnv taskType, currentHwnd, currentIndex, wndStatus, selectWnds,operateType
Dimenv statusMsg, msg1, msg2, msg3, msg4, msg5, msg6
DimEnv wnd1Name, wnd2Name, wnd3Name, wnd4Name, wnd5Name, wnd6Name
Dimenv S_RUN, S_WAIT, S_STOP
Dimenv TASK_1, TASK_2, TASK_3, TASK_4, TASK_5, TASK_6, TASK_7, TASK_8, TASK_9
Dimenv TEAM_BREAK, TEAM_JOIN, TEAM_NO, EXE_BREAK, EXE_HUIFU, EXE_JOIN, EXE_CHAT, EXE_ITEM, EXE_SELL, EXE_YUDI, EXE_JIHE, EXE_CS, EXE_GJ
DimEnv OT_CHECKITEM
Dimenv teamStatus, exeStatus, teamStatusMask, currentTeamStatus, currentLockIndex, currentLockIndex1, lockVal, lockVal1, stopFight
Dimenv wnd1NeedLock, wnd2NeedLock, wnd3NeedLock, wnd4NeedLock, wnd5NeedLock, wnd6NeedLock
Dimenv wnd1NeedLock1, wnd2NeedLock1, wnd3NeedLock1, wnd4NeedLock1, wnd5NeedLock1, wnd6NeedLock1
Dim eventThreadId, isLeader, lastX, lastY, wndActive, unLockVal, unLockVal1
Dim mapX, mapY, curX, curY, wndIndex, wndHwnd,shezhiX, shezhiY, guajiFlag,checkGuaji,guajiX, guajiY
Dim hwndArr(6), processName
Function initEnv()
    NORMAL_SPEED = 11
    EAST = 1
    WEST = 2
    SOUTH = 4
    NORTH = 8
    EAST_SOUTH = 5
    EAST_NORTH = 9
    WEST_SOUTH = 6
    WEST_NORTH = 10
    S_RUN = 1
    S_WAIT = 2
    S_STOP = 3
    S_EXIT = 4
    isRun = S_STOP
    TASK_1 = 1
    TASK_2 = 2
    TASK_3 = 3
    TASK_4 = 4
    TASK_5 = 5
    TASK_6 = 6
    TASK_7 = 7
    TASK_8 = 8
    TASK_9 = 9
    WND_NUM = 6
    eventType = 0
    lastEventType = 0
    lastX = 0
    lastY = 0
    lastMKIndex = -1
    TEAM_BREAK = 1
    TEAM_JOIN = 2
    TEAM_NO = 3
    EXE_BREAK = 1
    EXE_HUIFU = 2
    EXE_JOIN = 3
    EXE_FISH = 4
    EXE_CHAT = 5
    EXE_ITEM = 6
    EXE_SELL = 7
    EXE_YUDI = 8
    EXE_JIHE = 9
    EXE_CS = 10
    EXE_GJ = 11
    stopFight = False
    wnd1NeedLock = False
    wnd2NeedLock = False
    wnd3NeedLock = False
    wnd4NeedLock = False
    wnd5NeedLock = False
    wnd6NeedLock = False
    wnd1NeedLock1 = False
    wnd2NeedLock1 = False
    wnd3NeedLock1 = False
    wnd4NeedLock1 = False
    wnd5NeedLock1 = False
    wnd6NeedLock1 = False
    lockVal = 0
    lockVal1 = 0
    operateType = 0
    OT_CHECKITEM = 1
End Function
Function init()
    Dim i
    For i = 0 To WND_NUM - 1
        hwndArr(i) = 0
    Next
    selectWnd = 0
End Function
Function initMapPos()
    mapX = 0
    mapY = 0
    dm.FindPic 93,2,637,424, "img\map.bmp", "000000", 0.9, 0, mapX, mapY
    initMapPos = False
    If mapX > 0 And mapY > 0 Then  
        initMapPos = True
    Else 
        dm.KeyDownChar "Ctrl"
        Delay myRnd(100) + 200
        dm.KeyPressChar "S"
        Delay myRnd(50) + 100
        dm.KeyUpChar "Ctrl"
        Delay myRnd(100) + 1000
        dm.FindPic 93,2,637,424, "img\map.bmp", "000000", 0.9, 0, mapX, mapY
        If mapX > 0 And mapY > 0 Then  
            initMapPos = True
        End If
    End If
End Function
Function initDm()
    Dim ret
    Plugin.RegDll.Reg ".\dm\dm.dll"
    Set dm = createobject("dm.dmsoft")
    ret = dm.SetPath (".\dm")
    ret = dm.SetDict(0, "font\ml_pos.txt")
    ret = dm.SetDict(1, "font\ml_map.txt")
    ret = dm.SetDict(2, "font\ml_dialog.txt")
    ret = dm.SetDict(3, "font\ml_name.txt")
    ret = dm.SetDict(4, "font\ml_code.txt")
    ret = dm.SetDict(5, "font\ml_status.txt")
    ret = dm.SetDict(6, "font\ml_item.txt")
    ret = dm.SetDict(7, "font\ml_chuansong.txt")
    ret = dm.SetDict(8, "font\ml_skill.txt")
    ret = dm.SetDict(9, "font\ml_skill_item.txt")
End Function
Function initSelected()
    selectWnds = 0
    If 1 = p1.wnd1.Value Then 
        selectWnds = selectWnds Or (2 ^ 0)
    End If
    If 1 = p1.wnd2.Value Then 
        selectWnds = selectWnds Or (2 ^ 1)
    End If
    If 1 = p1.wnd3.Value Then 
        selectWnds = selectWnds Or (2 ^ 2)
    End If
    If 1 = p1.wnd4.Value Then 
        selectWnds = selectWnds Or (2 ^ 3)
    End If
    If 1 = p1.wnd5.Value Then 
        selectWnds = selectWnds Or (2 ^ 4)
    End If
    If 1 = p1.wnd6.Value Then 
        selectWnds = selectWnds Or (2 ^ 5)
    End If
End Function
Function setNeedLock(flag)
    If 0 = wndIndex Then 
        wnd1NeedLock = flag
    End If
    If 1 = wndIndex Then 
        wnd2NeedLock = flag
    End If
    If 2 = wndIndex Then 
        wnd3NeedLock = flag
    End If
    If 3 = wndIndex Then 
        wnd4NeedLock = flag
    End If
    If 4 = wndIndex Then 
        wnd5NeedLock = flag
    End If
    If 5 = wndIndex Then 
        wnd6NeedLock = flag
    End If
End Function
Function setNeedLock1(flag)
    If 0 = wndIndex Then 
        wnd1NeedLock1 = flag
    End If
    If 1 = wndIndex Then 
        wnd2NeedLock1 = flag
    End If
    If 2 = wndIndex Then 
        wnd3NeedLock1 = flag
    End If
    If 3 = wndIndex Then 
        wnd4NeedLock1 = flag
    End If
    If 4 = wndIndex Then 
        wnd5NeedLock1 = flag
    End If
    If 5 = wndIndex Then 
        wnd6NeedLock1 = flag
    End If
End Function
Function getNeedLock()
    If 0 = wndIndex Then 
        getNeedLock = wnd1NeedLock 
    End If
    If 1 = wndIndex Then 
        getNeedLock = wnd2NeedLock
    End If
    If 2 = wndIndex Then 
        getNeedLock = wnd3NeedLock
    End If
    If 3 = wndIndex Then 
        getNeedLock = wnd4NeedLock
    End If
    If 4 = wndIndex Then 
        getNeedLock = wnd5NeedLock
    End If
    If 5 = wndIndex Then 
        getNeedLock = wnd6NeedLock
    End If
End Function
Function getNeedLock1()
    If 0 = wndIndex Then 
        getNeedLock = wnd1NeedLock1
    End If
    If 1 = wndIndex Then 
        getNeedLock = wnd2NeedLock1
    End If
    If 2 = wndIndex Then 
        getNeedLock = wnd3NeedLock1
    End If
    If 3 = wndIndex Then 
        getNeedLock = wnd4NeedLock1
    End If
    If 4 = wndIndex Then 
        getNeedLock = wnd5NeedLock1
    End If
    If 5 = wndIndex Then 
        getNeedLock = wnd6NeedLock1
    End If
End Function

Function lockWnd()
	Dim isActive
	isActive = True
    If getNeedLock Then 
    	lockWnd = False
        If isActive And Not wndActive Then 
            Plugin.Window.Active wndHwnd
            Delay 10
            dm.MoveTo lastX, lastY
            wndActive = True
            setMsg "窗口" & wndIndex & "已激活"
        End If
        Exit Function
    Else
        setNeedLock True
        Do  While currentLockIndex <> wndIndex And S_RUN = isRun
            Delay 130
        Loop
        If currentLockIndex <> wndIndex Then 
        	lockWnd = False
        	Exit Function
        End If
        
        lockWnd = True
        lockVal = lockVal + 1
        unLockVal = lockVal
        log currentLockIndex & " lock " & lockVal
        If isActive Then
            Plugin.Window.Active wndHwnd
            Delay 10
            dm.MoveTo lastX, lastY
            wndActive = True
            setMsg "窗口" & wndIndex & "已激活"
        End If
    End If
End Function

Function lockWnd1()
    If getNeedLock1 Then 
    	lockWnd1 = False
        Exit Function
    Else
        setNeedLock1 True
        Do  While currentLockIndex1 <> wndIndex And S_RUN = isRun
            Delay 130
        Loop
        If currentLockIndex1 <> wndIndex Then 
        	lockWnd1 = False
        	Exit Function
        End If
        
        lockWnd1 = True
        lockVal1 = lockVal1 + 1
        unLockVal1 = lockVal1
        log currentLockIndex1 & " lock1 " & lockVal1
    End If
End Function

Function unLockWnd()
	If unLockVal <> lockVal Then 
		log "invalid unlock, lock " & lockVal & " unlock " & unLockVal
		Exit Function
	End If
	
	Delay 188
	log currentLockIndex & " unlock " & unLockVal
	setNeedLock False
    currentLockIndex = -1
    unLockVal = 0
    If wndActive Then
        wndActive = False
        dm.GetCursorPos curX, curY
        lastX = curX
        lastY = curY
        setMsg "窗口" & wndIndex & "已释放"
    End If
End Function

Function unLockWnd1()
	If unLockVal1 <> lockVal1 Then 
		log "invalid unlock, lock1 " & lockVal1 & " unlock1 " & unLockVal1
		Exit Function
	End If
	
	log currentLockIndex1 & " unlock1 " & unLockVal1
	setNeedLock1 False
    currentLockIndex1 = -1
    unLockVal1 = 0
End Function

Function mouseMove(lenX, lenY)
    dm.GetCursorPos curX, curY

    If curY + lenY < 0 Then 
    	curY = Abs(lenY)
    End If
    lineMove curX + lenX, curY + lenY, NORMAL_SPEED + myRnd(NORMAL_SPEED)
End Function
Function mouseLeave(x1, y1, x2, y2)
    dm.GetCursorPos curX, curY
    If curX > x1 And curY > y1 And curX < x2 And curY < y2 Then 
    	ret1 = lockWnd()
    	dm.MoveTo x2 + 5 + myRnd(10), curY + myRnd(10)
    	Delay 188
    	If ret1 Then 
    		unLockWnd
    	End If
    End If
End Function
Function lineMove(targetX, targetY, speed)
    Dim ret, i
    Dim perX, perY, moveNum
    Dim moveDisX, moveDisY
    dm.GetCursorPos curX, curY
    moveDisX = targetX - curX
    moveDisY = targetY - curY
    If Abs(moveDisX) > (moveDisY) Then 
        moveNum = Clng(Abs(moveDisX) / speed) + 1
    Else 
        moveNum = Clng(Abs(moveDisY) / speed) + 1
    End If
    perX = moveDisX / moveNum
    perY = moveDisY / moveNum
    For i = 1 To moveNum
        curX = curX + perX
        curY = curY + perY
        If i = moveNum Then 
            curX = targetX
            curY = targetY
        End If
        dm.MoveTo curX,curY
        Delay(20) + myRnd(20)
    Next
End Function
Function findMyPic(startX, startY, endX, endY, picName, isMove)
    curX = 0
    curY = 0
    dm.FindPic startX, startY, endX, endY, picName, "000000", 0.9, 0, curX, curY
    If curX > 0 And curY > 0 Then 
        If isMove Then 
            lineMove curX + 6, curY + 6, NORMAL_SPEED * 2
        End If
        findMyPic = True
    Else 
        findMyPic = False
    End If
End Function
Function findMyPic1(startX, startY, endX, endY, picName, isMove)
	Dim i, j, startX1, startY1, endX1, endY1
    curX = 0
    curY = 0
    findMyPic1 = False
    For i = 0 To 11
    	startX1 = startX + i * 50
        endX1 = startX1 + 100
        If endX1 > endX Then 
        	endX1 = endX
        End If
        For j = 0 To 10
            startY1 = startY + j * 50
            endY1 = startY1 + 100
            If endY1 > endY Then 
                endY1 = endY
            End If
            TracePrint  startX1 & " " & startY1 & " " &  endX1 & " " &  endY1
            dm.FindPic startX1, startY1, endX1, endY1, picName, "000000", 0.98, 0, curX, curY
            If curX > 0 And curY > 0 Then 
                If isMove Then 
                    lineMove curX + 6, curY + 6, NORMAL_SPEED * 2
                End If
            	findMyPic1 = True
                Exit Function
            End If
            If endY1 = endY Then
        		Exit For
        	End If
        Next
        If endX1 = endX Then 
        	Exit For
        End If
    Next
End Function
Function hasPanel()
    Dim ret1
    hasPanel = False
    ret1 = dm.CmpColor(294, 240, "99eef2-000000", 0.99)
    If 0 <> ret1 Then
        hasPanel = True
    End If
    ret1 = dm.CmpColor(293,239, "99eef2-000000", 0.99)
    If 0 <> ret1 Then
        hasPanel = True
    End If
    ret1 = dm.CmpColor(296,242, "faf8f1-000000", 0.99)
    If 0 <> ret1 Then
        hasPanel = True
    End If 
End Function
Function isFree(checkPanel)
    Dim ret1, i
    ret1 = findMyPic(110,20,137,35, "img\kashi.bmp", False)
    'ret1 = dm.CmpColor(343, 10, "addbcf-000000", 0.99)
    'If 0 = ret1 Then 
    '    ret1 = dm.CmpColor(343,15,"addbcf-000000", 0.99)
    'End If
    If ret1 Then
        isFree = True
        If Not checkPanel  Then 
            Exit Function
        End If
        For i = 0 To 10
            If not hasPanel() Then 
                Exit For
            End If
            Delay 200 + myRnd(10)
        Next
    Else 
        isFree = False
    End If
End Function
Function goHome()
    If isFree(False) = False Then 
        Delay myRnd(1000) + 1000
        goHome = False
    Else 
        dm.KeyPressChar "/"
        Delay 100 + myRnd(100)
        dm.KeyPressChar "h"
        Delay 100 + myRnd(100)
        dm.KeyPressChar "c"
        Delay 200 + myRnd(100)
        dm.KeyPressChar "enter"
        goHome = True
        Delay 200 + myRnd(100)
    End If
End Function
Function joinTeam()
    dm.KeyDownChar "Ctrl"
    Delay myRnd(100) + 200
    dm.KeyPressChar "L"
    Delay myRnd(50) + 100
    dm.KeyUpChar "Ctrl"
    Delay myRnd(100) + 300
End Function
Function waitExeStatus(status)
	log "wait " & status
    If teamStatus = TEAM_NO Then 
		log "finish wait " & status
		Exit Function
    End If
    If isLeader Then
        currentTeamStatus = 0
        exeStatus = status
        ret1 = lockWnd1()
        currentTeamStatus = currentTeamStatus Or (2 ^ wndIndex)
        If ret1 Then
            unLockWnd1
        End If
        setMsg "等待队员准备"
        Do While S_RUN = isRun
            If currentTeamStatus = teamStatusMask Then 
                setMsg "队员准备完成"
                Exit Do
            End If
            Delay 130
        Loop
        exeStatus = 0
    Else
        Do While exeStatus <> status And S_RUN = isRun
            Delay 130
        Loop
        log "等待状态完成"
        ret1 = lockWnd1()
        currentTeamStatus = currentTeamStatus Or (2 ^ wndIndex)
        If ret1 Then
            unLockWnd1
        End If
        
        setMsg "准备完成"
    End If
    log "finish wait " & status
End Function
Function clickMenuButton(name)
    clickMenuButton = clickButton(516,52,636,431, name)
End Function
Function together()
    keyStr "/z"
    Delay 500 + myRnd(100)
End Function
Function breakTeam()
    Dim ret1
    If teamStatus <> TEAM_JOIN Then
        Exit Function
    End If
    waitFree False
    waitExeStatus(EXE_BREAK)
    If isLeader And teamStatus = TEAM_JOIN Then 
        ret1 = lockWnd()
        together
        If ret1 Then
            unLockWnd
        End If	
    End If
    If isLeader Then 
    	ret1 = lockWnd()
        joinTeam
        If ret1 Then
            unLockWnd
        End If
        setMsg "解散队伍"
        TEAM_JOIN = TEAM_BREAK
    Else
        Do While TEAM_JOIN <> TEAM_BREAK And S_RUN = isRun
        	setMsg "等待解散"
            Delay 500 + myRnd(100)
        Loop
        setMsg "队伍已解散"
    End If
End Function
Function createTeam()
    Dim ret1
    createTeam = False
    waitFree False
    waitExeStatus(EXE_JOIN)
    If isLeader Then 
    	ret1 = lockWnd()
        keyStr "/a"
        If ret1 Then
            unLockWnd
        End If
        teamStatus = TEAM_JOIN
        setMsg "组队成功"
        createTeam = True
        exeStatus = 0
    Else
        Do While teamStatus <> TEAM_JOIN And S_RUN = isRun
            setMsg "等待确认"
            Delay 300 + myRnd(20)
        Loop
        setMsg "归队成功"
        createTeam = True
    End If
End Function
Function flushWnd()
    Dim hwnds, i, j, arr
    msg1 = "调用大漠插件获取窗口句柄。"
    readGameConfig("config\game.txt")
    hwnds = dm.EnumWindowByProcess(processName, "", "", 8 + 16)
    arr = split(hwnds, ",")
    msg1 = "获取窗口句柄成功，" & hwnds
    j = -1
    For i = 0 To WND_NUM - 1
    	j = j + 1
        If j > UBOUND(arr) Then
            hwndArr(i) = 0
        Else 
            If dm.GetWindowState(Clng(arr(j)), 3) > 0 Then 
                i = i - 1
            Else 
            	 hwndArr(i) = Clng(arr(j))
            End If
        End If
    Next
    wnd1Name = ""
    wnd2Name = ""
    wnd3Name = ""
    wnd4Name = ""
    wnd5Name = ""
    wnd6Name = ""
    If hwndArr(0) > 0 Then 
        wnd1Name = dm.GetWindowTitle(hwndArr(0))
    End If
    If hwndArr(1) > 0 Then 
        wnd2Name = dm.GetWindowTitle(hwndArr(1))
    End If
    If hwndArr(2) > 0 Then 
        wnd3Name = dm.GetWindowTitle(hwndArr(2))
    End If
    If hwndArr(3) > 0 Then 
        wnd4Name = dm.GetWindowTitle(hwndArr(3))
    End If
    If hwndArr(4) > 0 Then 
        wnd5Name = dm.GetWindowTitle(hwndArr(4))
    End If
    If hwndArr(5) > 0 Then 
        wnd6Name = dm.GetWindowTitle(hwndArr(5))
    End If
    msg1 = "窗口初始化完成，" & hwnds
End Function
Function disableControls()
    isRun = S_RUN
    p1.wnd1.Enabled = 0
    p1.wnd2.Enabled = 0
    p1.wnd3.Enabled = 0
    p1.wnd4.Enabled = 0
    p1.wnd5.Enabled = 0
    p1.wnd6.Enabled = 0
    p1.bt1.Enabled = 0
    p1.bt2.Enabled = 0
    p1.bt3.Enabled = 0
    p1.bt4.Enabled = 0
    p1.bt5.Enabled = 0
    p1.bt6.Enabled = 0
    p1.bt7.Enabled = 0
    p1.bt8.Enabled = 0
    p1.bt9.Enabled = 0
    p1.bt10.Enabled = 0
End Function
Function enableControls()
    isRun = S_STOP
    p1.wnd1.Enabled = 1
    p1.wnd2.Enabled = 1
    p1.wnd3.Enabled = 1
    p1.wnd4.Enabled = 1
    p1.wnd5.Enabled = 1
    p1.wnd6.Enabled = 1
    p1.bt1.Enabled = 1
    p1.bt2.Enabled = 1
    p1.bt3.Enabled = 1
    p1.bt4.Enabled = 1
    p1.bt5.Enabled = 1
    p1.bt6.Enabled = 1
    p1.bt7.Enabled = 1
    p1.bt8.Enabled = 1
    p1.bt9.Enabled = 1
    p1.bt10.Enabled = 1
    p1.stop.Enabled = 1
End Function
Function log(str)
    Dim fileName
    fileName = "log\wnd" & wndIndex + 1 & ".log"
    dm.WriteFile fileName, Now & " : " & str & Chr(13) &Chr(10)
End Function
Function setMsg(message)
    If 0 = wndIndex Then 
        msg1 = message
    End If
    If 1 = wndIndex Then 
        msg2 = message
    End If
    If 2 = wndIndex Then 
        msg3 = message
    End If
    If 3 = wndIndex Then 
        msg4 = message
    End If
    If 4 = wndIndex Then 
        msg5 = message
    End If
    If 5 = wndIndex Then 
        msg6 = message
    End If
    log (message)
End Function
Function treat()
    Dim i, ret1, tmp, index,mapPos
    Delay 1000 + myRnd(1000)
    treat = False
    tmp = getDialog(197,252,291,277)
    index = Instr(tmp, "治")
    If index > 0 Then 
        lineMove 200 + myRnd(200), 260 + myRnd(5), NORMAL_SPEED * 2
        Delay 600 + myRnd(300)
        dm.LeftClick
        Delay 1000 + myRnd(500)
        clickConfirm (True)
        Delay 1000 + myRnd(500)
        treat = True
    End If
    clickCancel
    setMsg "结束治疗"
End Function
Function huifuConfirm()
    Dim hasYes, hasConfirm, clickTimes
    For clickTimes = 0 To 10
        hasYes = checkDialogButton("yes")
        If  hasYes Then
            clickDialogButton ("yes")
            clickDialogButton("confirm")
            Exit For
        End If
        hasConfirm = checkDialogButton("confirm")
        If  hasConfirm Then
            clickDialogButton("confirm")
            Exit For
        End If
        Delay 200 + myRnd(100)         
    Next
End Function
Function huiFu()
    Dim tmp, index, huifuTimes,clickTimes, hasConfirm, hasYes, step1
    setMsg "开始回复"
    step1 = 1
    huiFu = False
    For huifuTimes = 0 To 10
        tmp = getDialog(262, 138, 399, 167)
        TracePrint tmp
        index = Instr(tmp, "回复")
        If index > 0 And 1 = step1 Then
            clickArea 207,191,407, 196
            huifuConfirm 
            step1 = step1 + 1
        End If
        If index > 0 And 2 = step1 Then
            clickArea 265,231,365, 236
            huifuConfirm 
            step1 = step1 + 1
        End If
        If index > 0 And 3 = step1 Then
            clickArea 221,271,321, 276
            huifuConfirm 
            clickDialogButton("cancel")
            huiFu = True
            Exit Function
        End If
        
        Delay 400 + myRnd(100)
    Next
End Function
Function executeTask()
    Dim ret1,lockRet, sRect, arr, wndX, wndY
    wndIndex = currentIndex
    wndHwnd = currentHwnd
    wndStatus = wndStatus Or (2 ^ wndIndex)
    lastX = 320
    lastY = 200
    wndActive = False
    unLockVal = 0
    initDm 
    'dm1.BindWindowEx(hwnd, "dx", "windows", "windows", "dx.public.anti.api", 6)
    'ret1 = dm.BindWindow(hwnd, "gdi", "windows", "windows", 0)
    ret1 = dm.BindWindow(wndHwnd, "gdi", "normal", "normal", 0)
    If ret1 = 0 Then
        setMsg "绑定窗口" & hwnd & "失败，退出执行任务"
        wndStatus = wndStatus And ((2 ^ WND_NUM - 1) Xor (2 ^ wndIndex))
        Exit Function	
    End If
    lockRet = lockWnd()
    ret1 = initMapPos
    If lockRet Then
    	unLockWnd
    End If
    
    If not ret1 Then
        setMsg "未找到游戏地图，退出"
        dm1.UnBindWindow
        wndStatus = wndStatus And ((2 ^ WND_NUM - 1) Xor (2 ^ wndIndex))
        Exit Function	
    End If
    dm1.DownCpu 80
    fileName = "log\wnd" & wndIndex + 1 & ".log"
    dm.DeleteFile  fileName
    setMsg "启动线程，绑定窗口，开始执行任务"
    executeScript("script\task_" & taskType & ".txt")
    dm1.UnBindWindow
    wndStatus = wndStatus And ((2 ^ WND_NUM - 1) Xor (2 ^ wndIndex))
End Function
Function startTask()
    Dim i, start, current, threadIds(5)
    start = Now
    currentIndex = 0
    wndStatus = 0
    msg1 = ""
    msg2 = ""
    msg3 = ""
    msg4 = ""
    msg5 = ""
    msg6 = ""
    statsMsg = ""
    teamStatusMask = selectWnds
    exeStatus = 0
    currentTeamStatus = 0
    wnd1NeedLock = False
    wnd2NeedLock = False
    wnd3NeedLock = False
    wnd4NeedLock = False
    wnd5NeedLock = False
    wnd6NeedLock = False
    wnd1NeedLock1 = False
    wnd2NeedLock1 = False
    wnd3NeedLock1 = False
    wnd4NeedLock1 = False
    wnd5NeedLock1 = False
    wnd6NeedLock1 = False
	currentLockIndex = - 1 
	currentLockIndex1 = - 1 
	lockVal = 0
	unLockVal = 0
	lockVal1 = 0
	unLockVal1 = 0
	wndIndex = -1
    For i = 0 To WND_NUM
        threadIds(i) = 0
        currentIndex = i
        currentHwnd = hwndArr(i)
        If (selectWnds And (2 ^ i)) > 0 Then 
            threadIds(i) = BeginThread(executeTask)
            Do While (wndStatus And (2 ^ i)) > 0
                Delay 50
            Loop
            Delay 100
        End If
    Next
    Do  While (wndStatus > 0)
        current = Now
        statusMsg = operateName & " 当前状态：运行中 开始时间：" & start & " 当前时间：" & current
        Delay 130
        If wnd1NeedLock And currentLockIndex = -1  Then
            currentLockIndex = 0
            log "wnd " & (currentLockIndex + 1) & " get lock"
        ElseIf wnd2NeedLock And currentLockIndex = -1 Then 
            currentLockIndex = 1
            log "wnd " & (currentLockIndex + 1) & " get lock"
        ElseIf wnd3NeedLock And currentLockIndex = -1 Then 
            currentLockIndex = 2
            log "wnd " & (currentLockIndex + 1) & " get lock"
        ElseIf wnd4NeedLock And currentLockIndex = -1 Then 
            currentLockIndex = 3
            log "wnd " & (currentLockIndex + 1) & " get lock"
        ElseIf wnd5NeedLock And currentLockIndex = -1 Then 
            currentLockIndex = 4
            log "wnd " & (currentLockIndex + 1) & " get lock"
        ElseIf wnd6NeedLock And currentLockIndex = -1 Then 
            currentLockIndex = 5
            log "wnd " & (currentLockIndex + 1) & " get lock"
        End If
        If wnd1NeedLock1 And currentLockIndex1 = -1  Then
            currentLockIndex1 = 0
            log "wnd " & (currentLockIndex1 + 1) & " get lock1"
        ElseIf wnd2NeedLock1 And currentLockIndex1 = -1 Then 
            currentLockIndex1 = 1
            log "wnd " & (currentLockIndex1 + 1) & " get lock1"
        ElseIf wnd3NeedLock1 And currentLockIndex1 = -1 Then 
            currentLockIndex1 = 2
            log "wnd " & (currentLockIndex1 + 1) & " get lock1"
        ElseIf wnd4NeedLock1 And currentLockIndex1 = -1 Then 
            currentLockIndex1 = 3
            log "wnd " & (currentLockIndex1 + 1) & " get lock1"
        ElseIf wnd5NeedLock1 And currentLockIndex1 = -1 Then 
            currentLockIndex1 = 4
            log "wnd " & (currentLockIndex1 + 1) & " get lock1"
        ElseIf wnd6NeedLock1 And currentLockIndex1 = -1 Then 
            currentLockIndex1 = 5
            log "wnd " & (currentLockIndex1 + 1) & " get lock1"
        End If
    Loop
    For i = 0 To WND_NUM
        If threadIds(i) > 0 Then
            StopThread threadIds(i)
            threadIds(i) = 0
        End If
    Next
    current = Now
    statusMsg = operateName & " 当前状态：已结束 开始时间：" & start & " 结束时间：" & current
End Function
Function checkButton(x1, y1, x2, y2, name)
    Dim ret1, picName
    picName = "img\" & name & ".bmp"
    ret1 = findMyPic(x1, y1, x2, y2, picName, False)
    If Not ret1  Then 
    	mouseMove 90 + myRnd(10), -(30 + myRnd(5))
        ret1 = findMyPic(x1, y1, x2, y2, picName, False)
    End If
    checkButton = ret1
End Function
Function clickButton(x1, y1, x2, y2, name)
	If Len(name) <= 0 Then 
		Exit Function
	End If
    Dim ret1, picName, findTimes
	log "click " & name
    clickButton = False
    picName = "img\" & name & ".bmp"
    For findTimes = 0 To 10
        ret1 = findMyPic(x1, y1, x2, y2, picName, True)
        If Not ret1 Then
        	mouseMove 90 + myRnd(10), -(30 + myRnd(5))
        	ret1 = findMyPic(x1, y1, x2, y2, picName, True)
        End If
        If ret1 Then 
            Exit For
        End If
        Delay 210
    Next
    If Not ret1 Then 
        Exit Function
    End If
    dm.LeftClick 
    Delay myRnd(50) + 500
    clickButton = True
End Function
Function checkDialogButton(name)
	For times = 0 To 4
    	If hasPanel() Then
        	Exit For
        End If
        Delay 210
    Next
    checkDialogButton = checkButton(20,170,584,427,name)
End Function
Function clickDialogButton(name)
	Dim times
	For times = 0 To 4
    	If hasPanel() Then
        	Exit For
        End If
        Delay 210
    Next
    clickDialogButton = clickButton(20,170,584,427,name)
End Function
Function getGamePos()
    Dim pos(2), tmp1, tmp2, extTimes
    Dim x1, y1, x2, y2
    x1 = mapX - 25
    y1 = mapY + 12
    x2 = mapX + 17
    y2 = mapY + 39
    dm.UseDict 0
    For extTimes = 0 To 20
        tmp1 = dm.Ocr(x1, y1, x2, y2, "ffffff-000000|fefefe-000000|fdfdfd-000000|fcfcfc-000000|fbfbfb-000000|fafafa-000000|f9f9f9-000000|f8f8f8-000000|f7f7f7-000000|f6f6f6-000000", 0.95)
        pos(0) = 0
        pos(1) = 0
        If tmp1 <> "" Then 
            tmp2 = dm.Ocr(x1 + 105, y1, x2 + 105, y2, "ffffff-000000|fefefe-000000|fdfdfd-000000|fcfcfc-000000|fbfbfb-000000|fafafa-000000|f9f9f9-000000|f8f8f8-000000|f7f7f7-000000|f6f6f6-000000", 0.95)
            If tmp2 <> "" Then 
                pos(0) = Clng(tmp1)
                pos(1) = Clng(tmp2)
                log "识别地图 " & pos(0) & "," & pos(1)
                getGamePos = pos
                Exit Function
            End If
        End If
        Delay 100 + myRnd(10)
    Next
    getGamePos = pos
End Function

Function getGameMap()
    Dim tmp, extTimes, posLen,ret1
    dm.UseDict 1
    getGameMap = ""
    mouseLeave mapX - 55, mapY + 128, mapX + 109, mapY + 158
    'tmp = dm.Ocr(mapX - 90, mapY + 80, mapX + 130, mapY + 180, "fffcf3-000000|d1c3ab-000000|948861-000000|f4ecd6-000000|d1c3ab-000000|f4eed7-000000", 0.95)
    For extTimes = 0 To 20
        tmp = dm.Ocr(mapX - 55, mapY + 128, mapX + 109,mapY + 158, "ffffff-000000|fefefe-000000|fdfdfd-000000|fcfcfc-000000|fbfbfb-000000|fafafa-000000|f9f9f9-000000|f8f8f8-000000|f7f7f7-000000|f6f6f6-000000", 0.95)
        If tmp <> "" Then 
        	log "当前地图 " &  tmp
            getGameMap = tmp
            Exit Function
        End If
        Delay 100 + myRnd(10)
    Next
    
    getGameMap = ""
End Function

Function isSameMap(mapName1, mapName2)
	isSameMap = False
	If "" <> mapName2 And Instr(mapName1, mapName2) > 0 Then
		isSameMap = True	
	End If
End Function

Function ocrText(dictIndex, x1, y1, x2, y2, textColor)
	dm.UseDict dictIndex
	mouseLeave x1, y1, x2, y2
    ocrText = dm.Ocr(x1, y1, x2, y2, textColor, 0.95)
End Function

Function getDialog(x1, y1, x2, y2)
    getDialog = ocrText(2, x1, y1, x2, y2,"ffffff-000000")
End Function

Function getCS(x1, y1, x2, y2)
    getCS = ocrText(7, x1, y1, x2, y2, "00ff00-000000")
End Function

Function getSkill(x1, y1, x2, y2)
    getSkill = ocrText(8, x1, y1, x2, y2,"ffffff-000000")
End Function
Function getSkillItem(x1, y1, x2, y2)
    getSkillItem = ocrText(9, x1, y1, x2, y2,"ffffff-000000")
End Function

Function findNPC(name, isMove)
    Dim i, findNum, curFind, tmp, pos(2), arr1, arr2, arr3, index, count
    dm.UseDict 3
    findNPC = False
    tmp = dm.OcrEx(2, 66, 542, 371, "ffffff-000000", 0.95)
    TracePrint tmp
    If Len(tmp) <= 0 Then
        Exit Function
    End If
    arr1 = split(tmp, "|")
    count = Len(name)
    findNum = 0
    curFind = 0
    For i = 1 To count
        index = Instr(arr1(0), Mid(name, i, 1))
        If (index > 0) Then 
            If curFind > i Then 
                findNPC = False
                Exit For
            End If
            curFind = i 
            findNum = findNum + 1
            arr2 = split(arr1(index), ",")
            pos(0) = Clng(arr2(0))  + (Clng(count / 2) - i) * 14 + 32 + myRnd(16)
            pos(1) = Clng(arr2(1)) + 72 - myRnd(12)
            If findNum > 1 Then
                findNPC = True
            End If
        End If
    Next
    If findNPC And isMove Then 
        If (pos(0) < 285) Or (pos(0) > 350) Or (pos(1) < 215) Or (pos(1) > 260) Then 
            lineMove pos(0), pos(1), NORMAL_SPEED * 2
            dm.LeftClick
        End If
    End If
End Function
Function getValidCode()
    Dim tmp, i
    dm.UseDict 4
    tmp = ""
    For i = 0 To 100
        'tmp = dm.Ocr(187, 221, 333, 235, "ffffff-000000", 0.9)
        tmp = dm.Ocr(226,191,306,213, "ffffff-000000", 0.9)
        If Len(tmp) = 4 Or Len(tmp) = 6 Then 
            Exit For
        End If
        Delay 20
    Next
    getValidCode = tmp
End Function
Function useItem(itemPic)
    Dim ret
    curX = 0
    curY = 0
    dm.FindPic 118,17,585,274, "img\item.bmp", "000000", 0.95, 0, curX, curY
    If curX <= 0 Or curY <= 0 Then
        dm.KeyDownChar "Ctrl"
        Delay myRnd(100) + 200
        dm.KeyPressChar "E"
        Delay myRnd(50) + 100
        dm.KeyUpChar "Ctrl"
        Delay myRnd(100) + 700
        dm.FindPic 118,17,585,274, "img\item.bmp", "000000", 0.95, 0, curX, curY
    End If

    If curX <= 0 Or curY <= 0 Then 
    	Delay myRnd(100) + 300
    	dm.KeyDownChar "Ctrl"
    	Delay myRnd(100) + 200
    	dm.KeyPressChar "E"
    	Delay myRnd(50) + 100
   	    dm.KeyUpChar "Ctrl"
   	    setMsg "打开物品栏失败"
        Exit Function
    End If
    
    mouseLeave 81, 69, 627, 429
    ret = findMyPic(81, 69, 627, 429, itemPic, True)
 
    If False = ret Then 
        useItem = False
        setMsg "没有找到物品"
        dm.KeyDownChar "Ctrl"
        Delay myRnd(100) + 200
        dm.KeyPressChar "E"
        Delay myRnd(50) + 100
        dm.KeyUpChar "Ctrl"
        Delay myRnd(100) + 200
        Exit Function
    End If
    useItem = True
    Delay myRnd(200) + 100
    dm.LeftDoubleClick
    Delay myRnd(200) + 100
    dm.FindPic 118,17,585,274, "img\item.bmp", "000000", 0.95, 0, curX, curY
    If curX > 0 And curY > 0 Then 
    	dm.KeyDownChar "Ctrl"
        Delay myRnd(100) + 200
        dm.KeyPressChar "E"
        Delay myRnd(50) + 100
        dm.KeyUpChar "Ctrl"
        Delay myRnd(100) + 200
    End If
End Function

Function getOppositeDirect(direct)
	getOppositeDirect = EAST
	If direct = EAST Then
        getOppositeDirect = WEST
    ElseIf direct = WEST Then
        getOppositeDirect = EAST
    ElseIf direct = SOUTH Then
        getOppositeDirect = NORTH
    ElseIf direct = NORTH Then
        getOppositeDirect = SOUTH
    ElseIf direct = EAST_SOUTH Then
        getOppositeDirect = WEST_NORTH
    ElseIf direct = EAST_NORTH Then
        getOppositeDirect = WEST_SOUTH
    ElseIf direct = WEST_SOUTH Then
        getOppositeDirect = EAST_NORTH
    ElseIf direct = WEST_NORTH Then
        getOppositeDirect = EAST_SOUTH
    End If
End Function
Function getDirectGamePos(direct, steps)
    Dim mapPos
    Dim posArr(2)
    mapPos = getGamePos
    If direct = EAST Then
        posArr(0) = mapPos(0) + steps
        posArr(1) = mapPos(1)
    ElseIf direct = WEST Then
        posArr(0) = mapPos(0) - steps
        posArr(1) = mapPos(1)
    ElseIf direct = SOUTH Then
        posArr(0) = mapPos(0)
        posArr(1) = mapPos(1) + steps
    ElseIf direct = NORTH Then
        posArr(0) = mapPos(0)
        posArr(1) = mapPos(1) - steps
    ElseIf direct = EAST_SOUTH Then
        posArr(0) = mapPos(0) + steps
        posArr(1) = mapPos(1) + steps
    ElseIf direct = EAST_NORTH Then
        posArr(0) = mapPos(0) + steps
        posArr(1) = mapPos(1) - steps
    ElseIf direct = WEST_SOUTH Then
        posArr(0) = mapPos(0) - steps
        posArr(1) = mapPos(1) + steps
    ElseIf direct = WEST_NORTH Then
        posArr(0) = mapPos(0) - steps
        posArr(1) = mapPos(1) - steps
    End If
    getDirectGamePos = posArr
End Function
Function getDirectPos(direct, steps)
    Dim posX, posY, stepX, stepY
    Dim posArr(2)
    posX = 305
    posY = 228
    stepX = 32
    stepY = 24
    If direct = EAST Then
        posArr(0) = posX + stepX * steps
        posArr(1) = posY - stepY * steps
    ElseIf direct = WEST Then
        posArr(0) = posX - stepX * steps
        posArr(1) = posY + stepY * steps
    ElseIf direct = SOUTH Then
        posArr(0) = posX + stepX * steps
        posArr(1) = posY + stepY * steps
    ElseIf direct = NORTH Then
        posArr(0) = posX - stepX * steps
        posArr(1) = posY - stepY * steps
    ElseIf direct = EAST_SOUTH Then
        posArr(0) = posX + stepX * 2 * steps
        posArr(1) = posY
    ElseIf direct = EAST_NORTH Then
        posArr(0) = posX
        posArr(1) = posY - stepY * 2 * steps
    ElseIf direct = WEST_SOUTH Then
        posArr(0) = posX
        posArr(1) = posY + stepY * 2 * steps
    ElseIf direct = WEST_NORTH Then
        posArr(0) = posX - stepX * 2 * steps
        posArr(1) = posY
    End If
    getDirectPos = posArr
End Function
Function faceTo(direct)
    Dim clickPos
    clickPos = getDirectPos(direct, ((myRnd(20) Mod 3) + 1))
    lineMove clickPos(0) + myRnd(Clng(32 * 0.8)), clickPos(1) + myRnd(Clng(24 * 0.8)), NORMAL_SPEED
    dm.RightClick
End Function
Function waitFree(checkPanel)
    Dim waitTimes
    waitTimes = 0
    Do While (Not isFree(checkPanel)) And (isRun = S_RUN)
        waitTimes = waitTimes + 1
        Delay 200 + myRnd(10)
    Loop
End Function
Function getWalkPlan(srcX, srcY, destX, destY, isSwitch)
    Dim plan(4), tmp1, tmp2
    plan(0) = EAST
    plan(1) = destX - srcX
    plan(2) = SOUTH
    plan(3) = destY - srcY
    If plan(1) < 0 Then
        plan(0) = WEST
        plan(1) = Abs(plan(1))
    End If
    If plan(3) < 0 Then
        plan(2) = NORTH
        plan(3) = Abs(plan(3))
    End If
    If plan(1) > 0 And plan(3) > 0 Then
        If plan(1) < plan(3) Then
            plan(3) = plan(3) - plan(1)
            plan(0) = plan(0) + plan(2)
            If plan(3) = 1 And plan(1) > 1 Then 
                plan(3) = 2
                plan(1) = plan(1) - 1
            End If
        Else
            plan(1) = plan(1) - plan(3)
            plan(2) = plan(2) + plan(0)
            If plan(1) = 1 And plan(3) > 1 Then 
                plan(1) = 2
                plan(3) = plan(3) - 1
            End If
        End If
    End If
    If plan(1) > 0 And plan(3) > 0 Then
        If (isSwitch > 0 And plan(3) > 1) Or plan(1) = 1 Then
            tmp1 = plan(0)
            tmp2 = plan(1)
            plan(0) = plan(2)
            plan(1) = plan(3)
            plan(2) = tmp1
            plan(3) = tmp2
        End If
    Else
        If (plan(1) = 0) Then
            plan(0) = plan(2)
            plan(1) = plan(3)
            plan(2) = 0
            plan(3) = 0
        End If
    End If
    getWalkPlan = plan
End Function
Function walkTo(curMapName, mapX, mapY, hasNext)
    Dim distanceX, distanceY, mapPos, tmpPos
    Dim plan, steps, clickPos, mapName
    Dim posX, posY, stepX, stepY, startX, startY
    Dim errTimes, j, k, checkChange, lastDirect
    Dim runSteps, sumSteps, diff, mapErrTimes
    walkTo = False
    setMsg "前往" & curMapName & " (" & mapX & "," & mapY & ")"
    mapPos = getGamePos()
    mapName = getGameMap()
    If mapName = "" Or 0 = mapPos(1) Then 
        waitFree True
        mapName = getGameMap()
        mapPos = getGamePos()
    End If
    If mapPos(0) = mapX And mapPos(1) = mapY Then 
    	walkTo = True
    	Exit Function
    End If
    
    errTimes = 0
    runSteps = 0
    sumSteps = 0
    mapErrTimes = 0
    Do While errTimes <= 4
        If isRun <> S_RUN Then 
            Exit Function
        End If
        log "game pos:" & mapName & " " & mapPos(0) & "," & mapPos(1)
        If Not isSameMap(curMapName, mapName) Then 
            log("地图不匹配")
            Exit Do
        End If
        If mapPos(0) < 1 Or mapPos(1) < 1 Then 
            log("无法识别坐标")
            Exit Do
        End If
        For checkChange = 0 To 3
            If runSteps = 0 Then 
                Exit For
            End If
            Delay 400 + myRnd(10)
            waitFree False
            mapName = getGameMap()
            If "" = mapName Then 
                errTimes = errTimes + 1
                mapName = curMapName
                If mapErrTimes > 3 Then
                    waitFree True
                    mapName = getGameMap()
                End If
            Else 
                mapErrTimes = 0
            End If
            tmpPos = getGamePos()
            If mapName = "" Or 0 = tmpPos(1) Then 
            	waitFree True
            	mapName = getGameMap()
            	tmpPos = getGamePos()
            End If
            
            If sumSteps > 2 Or hasNext Then 
                Exit For
            Else 
                log (Abs(tmpPos(0) - mapPos(0)) + Abs(tmpPos(1) - mapPos(1))) & "," & diff
                If (Abs(tmpPos(0) - mapPos(0)) + Abs(tmpPos(1) - mapPos(1))) >= diff Then
                    Exit For
                End If
            End If
            If sumSteps <= 2 AND Not isSameMap(curMapName, mapName) Then
                Exit For
            End If
        Next
        If runSteps > 0 Then 
            mapPos(0) = tmpPos(0)
            mapPos(1) = tmpPos(1)
            If sumSteps <= 3 And Not hasNext Then 
                log "pos:" & mapPos(0) & ","& mapPos(1)
                If mapPos(0) = mapX And mapPos(1) = mapY Then 
                    Delay 600
                    mapPos = getGamePos()
                    If mapPos(0) = mapX And mapPos(1) = mapY Then 
                        walkTo = True
                        Exit Do
                    End If
                End If
                If Not isSameMap(curMapName, mapName) Then
                    walkTo = True
                    Exit Do
                End If
            End If
        End If
        plan = getWalkPlan(mapPos(0), mapPos(1), mapX, mapY, myRnd(1))
        log "plan" & plan(0) &"," & plan(1) & " " & plan(2)  &"," & plan(3)
        diff = 0
        
        If sumSteps > 0 Then 
        	If sumSteps <= 3 And (plan(1) + plan(3)) > 6 And Not hasNext Then 
        		walkTo = True
        		Exit Do
        	End If
            If sumSteps <= (plan(1) + plan(3)) Then
                errTimes = errTimes + 1
            Else
                errTimes = 0
                sumSteps = plan(1) + plan(3)
            End If
        Else 
            sumSteps = plan(1) + plan(3)
        End If
        diff = 0
        runSteps = 0
        If sumSteps <= 3 Then 
        	If hasNext Then 
        		runSteps = plan(1)	
        	Else 
        		runSteps = 1
        	End If
        Else 
            runSteps = 2
        End If
        If runSteps > 0 Then 
            clickPos = getDirectPos(plan(0), runSteps)
            lineMove clickPos(0) + myRnd(Clng(32 * 0.6)), clickPos(1) + myRnd(Clng(24 * 0.6)), NORMAL_SPEED * 4
            diff = runSteps
            dm.LeftClick
            If (plan(0) > SOUTH) AND (plan(0) <> NORTH) Then
                diff = diff + runSteps
            End If
            If sumSteps <= 3 And hasNext Then 
            	walkTo = True
            	Exit Function
            End If
        End If
    Loop
End Function
Function canWalk()
    Dim mapPos1,clickPos,mapPos2
    mapPos1 = getGamePos()
    clickPos = getDirectPos(EAST, 1)
    lineMove clickPos(0) + myRnd(Clng(32 * 0.6)), clickPos(1) + myRnd(Clng(24 * 0.6)), NORMAL_SPEED
    dm.LeftClick
    Delay 300
    clickPos = getDirectPos(NORTH, 1)
    lineMove clickPos(0) + myRnd(Clng(32 * 0.6)), clickPos(1) + myRnd(Clng(24 * 0.6)), NORMAL_SPEED
    dm.LeftClick
    Delay 400
    canWalk = True
    mapPos2 = getGamePos()
    If (mapPos1(0) = mapPos2(0)) And (mapPos1(1) = mapPos2(1)) Then
        canWalk = False
    Else 
    	walkTo getGameMap(), mapPos1(0), mapPos1(1), False
    End If
End Function
Function checkLeader()
    Dim ret1
    ret1 = lockWnd()
    currentTeamStatus = currentTeamStatus And ((2 ^ WND_NUM - 1) Xor (2 ^ wndIndex))
    teamStatusMask = teamStatusMask Or (2 ^ wndIndex)
    If canWalk Then 
        isLeader = True
        keyStr "/g"
        setMsg "我是队长"
        teamStatus = TEAM_JOIN   
    Else 
    	isLeader = False
        setMsg "我是队员"
    End If
    If ret1 Then
        unLockWnd
    End If
    waitExeStatus EXE_JOIN
End Function
Function readGameConfig(fileName)
    Dim tmp, count, arr1(100, 10), arr2, lineNum, fd, attrNum

    fd = Plugin.File.OpenFile(dm.GetPath() & fileName)
    If fd <= 0 Then
        Exit Function
    End If
    lineNum = 0

    Do While True
        tmp = Plugin.File.ReadLine(fd)
        tmp = Replace(tmp, "" & vbLf, "")
        tmp = Replace(tmp, "" & vbTab, "")
        tmp = Replace(tmp, "" & vbCr, "")
        tmp = Replace(tmp, " ", "")
        If "" = tmp Then 
            Exit Do
        End If
        processName = tmp
    Loop
    Plugin.File.CloseFile (fd)
End Function
Function readScript(fileName)
    Dim tmp, count, arr1(100, 10), arr2, lineNum, fd, attrNum

    fd = Plugin.File.OpenFile(dm.GetPath() & fileName)
    If fd <= 0 Then
        readScript = arr1
        Exit Function
    End If
    lineNum = 0

    Do While True
        tmp = Plugin.File.ReadLine(fd)
        tmp = Replace(tmp, "" & vbLf, "")
        tmp = Replace(tmp, "" & vbTab, "")
        tmp = Replace(tmp, "" & vbCr, "")
        tmp = Replace(tmp, " ", "")
        If "" = tmp Then 
            Exit Do
        End If
        arr2 = split(tmp, ",")
        count = UBOUND(arr2)
        For attrNum = 0 To count
            arr1(lineNum, attrNum) = arr2(attrNum)
        Next
        lineNum = lineNum + 1
    Loop
    Plugin.File.CloseFile(fd)
    readScript = arr1
End Function

Function openItemSkill(skillName, itemName)
	Dim ret1, openTimes, str1, tmpX, tmpY, tmpX1, tmpY1, itemIndex, lastItemName, isSame
	
	isSame = False
    openItemSkill = False
    curX = 0
    curY = 0
    dm.KeyDownChar "Ctrl"
    Delay myRnd(100) + 200
    dm.KeyPressChar "W"
    Delay myRnd(50) + 100
    dm.KeyUpChar "Ctrl"
    Delay myRnd(100) + 700
    For openTimes = 0 To 3
        dm.FindPic 50,17,585,274, "img\job.bmp", "000000", 0.95, 0, curX, curY
        If curX > 0 And curY > 0 Then 
            Exit For
        End If
        If openTimes = 3 Then 
        	setMsg "没有发现技能面板"
            Exit Function
        End If
        Delay 400 + myRnd(100)
    Next
    
    tmpX = curX
    tmpY = curY + 36
    tmpX1 = tmpX
    tmpY1 = tmpY
    For csTimes = 0 To 9
        str1 = getSkill(tmpX1, tmpY1, tmpX1 + 118, tmpY1 + 22)
        If "" = str1 Then 
        	setMsg "没有找到制造技能"
        	Exit Function
        End If
        If skillName = str1 Then 
        	clickArea tmpX1 + 20, tmpY1 + 4, tmpX1 + 60, tmpY1 + 12
        	Delay 900
        	clickArea tmpX + 20, tmpY + 4, tmpX + 60, tmpY + 12
        	Exit For
        End If
        
        If 9 = csTimes Then 
        	setMsg "没有发现技能"
        	Exit Function
        End If
        tmpY1 = tmpY1 + 16
    Next
    
    tmpY1 = tmpY
    For csTimes = 0 To 15
    	tmpY1 = tmpY
        For itemIndex = 0 To 9
            str1 = getSkillItem(tmpX1, tmpY1, tmpX1 + 118, tmpY1 + 22)
            log str1
            If "" = str1 Then 
            	setMsg "没有找到制造物品"
            	Exit Function
            End If
            
            If str1 = itemName Then 
            	clickArea tmpX1 + 20, tmpY1 + 4, tmpX1 + 60, tmpY1 + 12
        		Delay 800
                openItemSkill = True
                setMsg "打开制造物品面板"
                Exit Function
            End If

            If itemIndex = 0 Then
                If lastItemName <> "" And str1 = lastItemName And isSame Then 
                    lastItemName = ""
                    Exit For
                End If
                If str1 = lastItemName Then 
                	isSame = True
                End If
                lastItemName = str1
            End If
            tmpY1 = tmpY1 + 16
        Next

        If lastItemName = "" And str1 <> "" Then 
            Exit For
        End If
        For itemIndex = 0 To 9
        	If str1 = "" Then
            	Exit For
            End If
            clickArea tmpX + 208, tmpY + 152, tmpX + 213, tmpY + 157
            Delay 130
            Exit For
        Next
    Next
	setMsg "没有找到制造物品"	
End Function

Function itemSkillAndSell(command, len)
	Dim ret1, skillC(20), sellC(3), i,j,freeNum,ret2,info
	
	itemSkillAndSell = True
	info = getCharInfo()
    If info(1) < 200 Then
        Exit Function
    End If
    
	sellC(0) = "sell"
	sellC(1) = command(1)
	sellC(2) = command(2)
	
	j = 1
	skillC(0) = "zhizao"
	For i = 3 To len - 1
		skillC(j) = command(i)
		j = j + 1
	Next
	
	Do While True
		ret1 = itemSkill(skillC, len - 2)
		ret2 = lockWnd()
		freeNum = getItemFreeNum()
		If ret2 Then
        	unLockWnd
   	 	End If
		sell sellC, 3
		If Not ret1 And freeNum > 2 Then 
			setMsg "制造失败，退出"
			Exit Do
		End If
		
		info = getCharInfo()
    	If info(1) < 200 Then
        	Exit Function
   		End If
	Loop
End Function

Function itemSkill(command, len)
	Dim ret1,itemPic,skillTimes,ret2, freeNum
	itemSkill = False
    If len < 4 Then
        setMsg "zhizao 命令至少需要3个参数"
        Exit Function
    End If
    
    ret1 = lockWnd()
    ret2 = openItemSkill(command(1), command(2))
    If Not ret2  Then 
    	keyStr "/z"
    	Exit Function
    End If
    freeNum = getItemFreeNum()
	Do While True
        For skillTimes = 3 To len - 1
        	itemPic = "item\" & command(skillTimes) & ".bmp"
        	TracePrint itemPic
        	ret2 = findMyPic(271,77,623,417, itemPic, True)
    		If ret2 Then 
    			mouseMove 15, 10
    			Delay 88
    			dm.LeftDoubleClick 
    		End If
    	Next
    	If checkDialogButton("zhixing1") Then
            clickDialogButton "zhixing1"
            itemSkill = True
            freeNum = freeNum - 1
       	Else 
       		keyStr "/r"
       		setMsg "材料出错，不可制造"
       		Exit Do
        End If
        keyStr "/r"
    	If checkDialogButton("zhixing2") Then
            clickDialogButton "zhixing2"
       	Else 
       		setMsg "无继续执行按钮，退出"
       		Exit Do
        End If
        If freeNum <= 0 Then 
        	freeNum = getItemFreeNum()
        	If freeNum <= 0 Then 
        		setMsg "物品已满，退出"
       			Exit Do
       		End If
        End If
    Loop
	keyStr "/z"
	If ret1 Then
        unLockWnd
    End If
End Function

Function goRnd(command, len)
    Dim ret1, mapPos1, mapPos2,faceTo, moveX, moveY
    goRnd = False
    If teamStatus = TEAM_JOIN And Not isLeader Then
        log "非队长，不执行"
        goRnd = True
        Exit Function
    End If

    mapPos1 = getGamePos()
    If len = 3 Then
        moveX = Clng(command(1))
        moveX = (Abs(moveX) / moveX) * (myRnd(Abs(moveX))) + 1
        moveY = Clng(command(2))
        moveY = (Abs(moveY) / moveY) * (myRnd(Abs(moveY))) + 1
    Else
        faceTo = 1
        If (Clng(dm.GetTime() / 1000) Mod 2) = 0 Then 
    	    faceTo = -1
            moveX = (myRnd(5) + 1) * faceTo
            moveY = (myRnd(5) + 1) * faceTo
        End If
    End If
    
    ret1 = lockWnd()
    goRnd = walkTo(getGameMap(), mapPos1(0) + moveX, mapPos1(1) + moveY, False)
    If ret1 Then
        unLockWnd
    End If
End Function

Function goOffset(command, len)
    Dim ret1, mapPos1, moveX, moveY
    goOffset = False
    
    If len < 3 Then
        setMsg "gooffset 命令至少需要3个参数"
        Exit Function
    End If
    
    If teamStatus = TEAM_JOIN And Not isLeader Then
        log "非队长，不执行"
        goOffset = True
        Exit Function
    End If

    mapPos1 = getGamePos()
    moveX = Clng(command(1))
    moveY = Clng(command(2))
    ret1 = lockWnd()
    goOffset = walkTo(getGameMap(), mapPos1(0) + moveX, mapPos1(1) + moveY, False)
    If ret1 Then
        unLockWnd
    End If
End Function

Function go(command, len, hasNext)
    Dim ret1, ret2

    go = False
    If len < 4 Then
        setMsg "go 命令至少需要3个参数"
        Exit Function
    End If
    
    If teamStatus = TEAM_JOIN And Not isLeader Then
        log "非队长，不执行"
        go = True
        Exit Function
    End If
    waitFree False
    ret1 = lockWnd()
    If len = 5 And "1" = command(4) Then 
    	go = walkTo(command(1), Clng(command(2)), Clng(command(3)), False)
    Else 
    	go = walkTo(command(1), Clng(command(2)), Clng(command(3)), hasNext)
    End If
    
    If ret1 Then
        unLockWnd
    End If
End Function
Function home()
    Dim ret1, checkTimes, mapName
    home = False
    If (teamStatus = TEAM_JOIN And Not isLeader) Then
        log "非队长，不执行"
        home = True
        Exit Function
    End If
    waitFree False
    mapName = getGameMap()
    
    ret1 = lockWnd()
    
    If isSameMap("医院", mapName) Then 
        If checkDialogButton("cancel") Then
            clickDialogButton "cancel"
       	End If 
        home = True
        If ret1 Then
            unLockWnd
        End If
        Exit Function
    End If
    keyStr "/yy"
    'clickArea 600, 89, 627, 101
    'Delay 50 + myRnd(50)
    'clickArea 600,89,627,101
    'Delay 500 + myRnd(100)
    'clickMenuButton "home"
    If ret1 Then
        unLockWnd
    End If
    For checkTimes = 0 To 5
        mapName = getGameMap()
        If isSameMap("医院", mapName) Then
            home = True
            Exit For
        End If
        Delay 300
    Next
End Function
Function item(command, len)
	Dim ret1, ret2, itemTimes
	
    item = False
    If len < 3 Then
        setMsg "item 命令至少需要2个参数"
    End If


    waitExeStatus(EXE_ITEM)
    If Clng(command(1)) = 0 AND not isLeader Then
        item = True
        Exit Function
    End If
    
    ret1 = lockWnd()
    setMsg "开始使用物品 " & command(2)
    If Not useItem("item\" & command(2) & ".bmp")  Then 
    	If ret1 Then
        	unLockWnd
    	End If
    	Exit Function
    End If
    
    If len > 3 Then
        For itemTimes = 3 To len -1
            clickDialogButton command(itemTimes)
        Next
    Else 
        If 0 = ret Then
            dm.KeyDownChar "Ctrl"
            Delay myRnd(100) + 200
            dm.KeyPressChar "E"
            Delay myRnd(50) + 100
            dm.KeyUpChar "Ctrl"
            Delay myRnd(100) + 500
        End If
    End If
    If ret1 Then
        unLockWnd
    End If
    item = True
End Function
Function chat(command, len)
    Dim chatTimes,ret1,ret2, str1
    chat = False
    If len < 3 Then
        setMsg "chat 命令至少需要2个参数"
    End If
    
    waitExeStatus EXE_CHAT
    If Clng(command(1)) = 0 AND not isLeader  Then 
    	waitExeStatus EXE_CHAT + 100
        chat = True
        Exit Function
    End If
    If Clng(command(1)) > 0 And isLeader And teamStatus = TEAM_JOIN Then
        ret1 = lockWnd()
        together
        If ret1 Then
            unLockWnd
        End If 
    End If
    
    waitFree False
    ret1 = lockWnd()
    log "面对npc"
    faceTo Clng(command(2))
    If len > 3 Then
        For chatTimes = 3 To len - 1
        	str1 = command(chatTimes)
        	log "chat " & str1
        	If dm.IsFileExist("img\" & str1 & ".bmp") > 0 Then 
        		Delay 200
        		clickDialogButton str1
        	ElseIf Left(str1, 1) = "f" Then 
        		dm.KeyPressChar str1
        		Delay 88
        	Else 
        		keyStr str1
        	End If
    	Next
    End If
    If ret1 Then
        unLockWnd
    End If
    waitExeStatus EXE_CHAT + 100
    chat = True
End Function
Function getCharInfo()
    Dim info(2), tmp1, tmp2, extTimes
    dm.UseDict 5
    info(0) = 0
    info(1) = 0
    For extTimes = 0 To 20
        tmp1 = dm.Ocr(11,18,50,29, "000001-000000", 0.95)
        If "" = tmp1 Then
            tmp1 = dm.Ocr(17,1,53,13, "000001-000000", 0.95)
        End If
        If tmp1 <> "" Then 
            tmp2 = dm.Ocr(14,25,53,43, "000001-000000", 0.95)
            If "" = tmp2 Then
                tmp2 = dm.Ocr(10,11,52,23, "000001-000000", 0.95)
            End If
            If tmp2 <> "" Then 
                info(0) = Clng(tmp1)
                info(1) = Clng(tmp2)
                log "查询血蓝 " & info(0) & "," & info(1)
                getCharInfo = info
                Exit Function
            End If
        End If
        Delay 100 + myRnd(10)
    Next
    getCharInfo = info
End Function

Function isWaitFight()
	Dim posLen
	
	curx = 0
	curY = 0
	isWaitFight = False
    dm.FindPic 50,17,585,274, "img\item.bmp", "000000", 0.95, 0, curX, curY
    If curX > 0 And curY > 0 Then 
    	isWaitFight = True
    	Exit Function
    End If
	dm.FindPic 50,17,585,274, "img\job.bmp", "000000", 0.95, 0, curX, curY
    If curX > 0 And curY > 0 Then  
    	isWaitFight = True
    	Exit Function
    End If
    
    posLen = Len(dm.FindColorEx(287, 206, 353, 273, "a6caf0-000000", 0.99, 0))
    TracePrint posLen
    If posLen > 5000 Then 
    	isWaitFight = True
    	Exit Function
    End If
End Function

Function getItemFreeNum()
    Dim ret1, x1, y1, checkTimes, str1,count
    
    dm.UseDict 6
    getItemFreeNum = -1
    curX = 0
    curY = 0
    dm.FindPic 118,17,585,274, "img\item.bmp", "000000", 0.95, 0, curX, curY
    If curX <= 0 Or curY <= 0 Then
        dm.KeyDownChar "Ctrl"
        Delay myRnd(100) + 200
        dm.KeyPressChar "E"
        Delay myRnd(50) + 100
        dm.KeyUpChar "Ctrl"
        Delay myRnd(100) + 700
        dm.FindPic 118,17,585,274, "img\item.bmp", "000000", 0.95, 0, curX, curY
    End If

    If curX <= 0 Or curY <= 0 Then 
    	Delay myRnd(100) + 300
    	dm.KeyDownChar "Ctrl"
    	Delay myRnd(100) + 200
    	dm.KeyPressChar "E"
    	Delay myRnd(50) + 100
   	    dm.KeyUpChar "Ctrl"
        Exit Function
    End If
    str1 = dm.Ocr(curX - 130, curY + 10, curX + 160, curY + 250, "fdf7e7-000000|fffbf0-000000", 0.99)
    getItemFreeNum = Len(str1) - Len(Replace(str1, "1", ""))
    setMsg "背包剩余" & getItemFreeNum & "空"
    Delay myRnd(100) + 300
    dm.KeyDownChar "Ctrl"
    Delay myRnd(100) + 200
    dm.KeyPressChar "E"
    Delay myRnd(50) + 100
    dm.KeyUpChar "Ctrl"
End Function
Function yudi(command, len)
    Dim i, ret1, info, minX, minL, direct, oppositeDirect, lastDirect, clickPos
    Dim mapPos, tmpMapName, curSec, lastSec, checkInterval, walkTimes, errTimes
    Dim startSec, endSec, stopFlag,freeNum
    yudi = True
    If len < 3 Then
        setMsg "yudi 命令至少需要2个参数"
        Exit Function
    End If
    
    minX = 150
    minL = 100
    endSec = 1200
    checkInterval = 300
    direct = Clng(command(1))
    mapName = command(2)
    errTimes = 0
    oppositeDirect = getOppositeDirect(direct)
    If Len > 3 Then
        endSec = Clng(command(3))
    End If
    If Len > 5 Then
        minX = Clng(command(4))
        minL = Clng(command(5))
    End If
    If teamStatus = TEAM_NO Or isLeader Then
        stopFight = False
    End If
    mapPos = getGamePos()
    stopFlag = False
    waitExeStatus (EXE_YUDI)
    startSec = Clng(dm.GetTime() / 1000)
    lastSec = startSec
    curSec = startSec
    walkTimes = 0
    lastDirect = oppositeDirect
    For i = 0 To 6
    	tmpMapName = getGameMap()
    	If "" <> tmpMapName Or guajiFlag Then 
    		Exit For
    	End If
    	Delay 200
    Next
    If Not isSameMap(mapName, tmpMapName) And direct > 0 Then 
     	stopFlag = True
     	If teamStatus <> TEAM_NO Then 
    		stopFight = stopFlag
    	End If
    	setMsg "地图不一致，退出"
        Exit Function
    End If
    Do While S_RUN = isRun
        If (teamStatus <> TEAM_JOIN Or isLeader) And direct > 0 And (Not isFree(False)) Then 
        	setMsg "走路"
        	If lastDirect = oppositeDirect Then 
        		clickPos = getDirectPos(direct, 3)
        		lastDirect = direct
        	Else 
        		clickPos = getDirectPos(oppositeDirect, 3)
        		lastDirect = oppositeDirect
        	End If
            
            ret1 = lockWnd()
            lineMove clickPos(0) + myRnd(Clng(32 * 0.6)), clickPos(1) + myRnd(Clng(24 * 0.6)), NORMAL_SPEED * 3
            dm.LeftClick 
            Delay 50 + myRnd(50)
            dm.LeftClick
            walkTimes = walkTimes + 1
            If (walkTimes > 15) Then 
            	walkTo mapName, mapPos(0), mapPos(1), False
            	walkTimes = 0
            End If
            If ret1 Then
                unLockWnd
            End If
        Else 
        	setMsg "战斗中等待2s"
        	Delay 2300
        End If
        
        setMsg "检查血魔"
        info = getCharInfo()
        If info(0) < minX Or info(1) < minL Then 
        	setMsg "血蓝太少，结束"
            stopFlag = True
        End If
        If Not isFree(False) Then 
        	If isWaitFight() Then
        		Delay 3000
        		If Not isFree(False) And isWaitFight() Then 
 					dm.KeyPressChar "f2"
        		End If
        	End If
        End If
        
        curSec = Clng(dm.GetTime() / 1000)
        tmpMapName = getGameMap()
        If "" = tmpMapName And direct > 0 Then 
         	setMsg "检查地图"
        	errTimes = errTimes + 1
        	tmpMapName = mapName
        	If errTimes > 3 Then
        		waitFree False
        		tmpMapName = getGameMap()
        	End If
        Else 
        	errTimes = 0
        End If
        If (teamStatus <> TEAM_JOIN Or isLeader) And direct > 0 And ((Not isSameMap(mapName, tmpMapName))) Then 
        	setMsg "地图变更，结束"
            stopFlag = True
       	End If

        If (curSec - startSec > 800) Then 
            checkInterval = 180
        End If
        If (((curSec - startSec) > endSec)) Then 
            setMsg "遇敌时间已经达到，结束"
            stopFlag = True
        ElseIf (curSec - lastSec) > checkInterval Then
            lastSec = curSec
            operateType = OT_CHECKITEM
        End If

        If  operateType = OT_CHECKITEM And direct > 0 Then 
        	setMsg "检查背包"
            waitFree True
            ret1 = lockWnd()
            freeNum = getItemFreeNum()
            If freeNum >= 0 And freeNum <= 1 Then 
            	setMsg "物品满了，结束"
                stopFlag = True
            End If
            If isLeader Then
            	 operateType = 0
       		End If
            If ret1 Then
                unLockWnd
            End If
        End If

     	If teamStatus <> TEAM_NO Then 
     		ret1 = lockWnd1()
     		If stopFlag Then 
     			stopFight = stopFlag
     		End If
     		If ret1 Then
                unLockWnd1
            End If
     		If stopFight Then 
     			stopFlag = stopFight
     			log "检测到有人需要停止战斗，结束"
     		End If
    	End If
        If stopFlag Then
            Exit Do
        End If
    Loop
    waitExeStatus EXE_YUDI + 100
End Function

Function clickArea(x1, y1, x2, y2)
    Dim lenX, lenY
    lenX = x2 - x1 - 3
    lenY = y2 - y1 - 3
    lineMove x1 + myRnd(lenX) + 2, y1 + myRnd(lenY) + 2, NORMAL_SPEED
    Delay 200 + (20)
    dm.LeftClick
    Delay 200 + (50)
End Function
Function keyStr(tmp)
    Dim i, slen
    slen = Len(tmp)
    For i = 1  to slen
        dm.KeyPressChar mid(tmp, i, 1)
        Delay 100 + myRnd(100)
    Next
    dm.KeyPressChar "enter"
    Delay 200 + myRnd(100)
    dm.KeyPressChar "enter"
    Delay 200 + myRnd(100)
End Function
Function waitPanel()
    Dim waitTimes
    waitPanel = False
    For waitTimes = 0 To 10
        If hasPanel() Then
            waitPanel = True
            Exit For
        End If
        If waitTimes > 9 Then
            Exit Function
        End If
        Delay 230
    Next
End Function
Function sell(command, len)
    Dim sellTimes,ret1,code, findShop, findValid, itemName,tmpX,tmpY,ret2,tmpX1,tmpY1
    sell = False
    If len < 2 Then
        setMsg "sell 命令至少需要1个参数"
        Exit Function
    End If
    
    itemName = ""
    If len = 3 Then 
    	itemName = command(2)
    End If
    If isLeader And teamStatus = TEAM_JOIN Then 
        ret1 = lockWnd()
        together
        If ret1 Then
            unLockWnd
        End If	
    End If
    waitExeStatus (EXE_SELL)
    setMsg "开始售卖"
    ret1 = lockWnd()
    faceTo Clng(command(1))
    Delay 300 + myRnd(100)
    If Not waitPanel() Then
        If ret1 Then
            unLockWnd
        End If
        setMsg "打开售卖界面失败"
        Exit Function
    End If
    clickArea 308,260,388,270
    findShop = False
    findValid = False
    Delay 300 + myRnd(100)
    For sellTimes = 0 To 6
        If 0 = dm.CmpColor(468,211, "000001-000000", 0.95) Then 
            If 0 = dm.CmpColor(509,279, "000001-000000", 0.95) Then
                findValid = True
            End If
        End If
        If findValid Then
            Exit For
        End If
        findShop = findMyPic(129,24,475,115, "img\shop.bmp", False)
        If findShop Then
            Exit For
        End If
        Delay 230
    Next
    If findValid Then
        code = getValidCode()
        If code = "" Then
            If ret1 Then
                unLockWnd
            End If
            setMsg "识别验证码失败"
            Exit Function
        End If
        keyStr code
        clickDialogButton "confirm"
        Delay 300 + myRnd(100)
        If Not waitPanel() Then
            If ret1 Then
                unLockWnd
            End If
            setMsg "打开售卖界面失败"
            Exit Function
        End If
        'clickArea 310,260,389,269
        For sellTimes = 0 To 4
            findShop = findMyPic(129,24,475,115, "img\shop.bmp", False)
            If findShop Then
                Exit For
            End If
            Delay 230
        Next
    End If
    If findShop Then
        If checkDialogButton("gall") Then
            clickDialogButton "cancel"
        Else 
        	If "" = itemName Then 
        		clickDialogButton "all"
        	Else 
        		curX = 0
    			curY = 0
    			dm.FindPic 129, 24, 475, 115, "img\shop.bmp", "000000", 0.98, 0, curX, curY
    			tmpX = curX + 20
    			tmpY = curY + 110
    			mouseLeave 25, 47, 553, 398
    			Delay 66
    			For sellTimes = 0 To 19
    				tmpX1 = tmpX + (sellTimes Mod 5) * 50
    				tmpY1 = tmpY + Clng(sellTimes \ 5) * 50
    				
    				ret2 = findMyPic(tmpX1, tmpY1, tmpX1+70, tmpY1 + 70, "item\" & itemName & ".bmp", True)
    				If ret2 Then 
    					mouseMove 15, 15
    					dm.LeftDoubleClick 
    					mouseLeave 25, 47, 553, 398
    				End If
    			Next
        	End If
            
            clickDialogButton "confirm"
            clickDialogButton "yes"
            If checkDialogButton("cancel") Then
    			clickDialogButton "cancel"
    		End If
        End If
        sell = True
    End If
    
    Delay 200 + myRnd(100)
    clickArea 308, 276, 388, 286
    If ret1 Then
        unLockWnd
    End If
    Delay 300 + myRnd(100)
End Function
Function jiaxue(command, len)
    Dim ret1
    jiaxue = False
    If len < 2 Then
        setMsg "jiaxue 命令至少需要1个参数"
    End If
    If isLeader And teamStatus = TEAM_JOIN Then 
        ret1 = lockWnd()
        together
        If ret1 Then
            unLockWnd
        End If	
    End If
    waitExeStatus(EXE_HUIFU)
    ret1 = lockWnd()
    faceTo Clng(command(1))
    jiaxue = huiFu
    If ret1 Then
        unLockWnd
    End If
    waitExeStatus(EXE_HUIFU + 100)
End Function

Function chuansong(command, len)
	Dim ret1, csTimes,mapName, mapIndex, tmpX, tmpY, name,curMap,lastName
	chuansong = False
	If len < 2 Then
        setMsg "cs 命令至少需要1个参数"
    End If
    curMap = getGameMap()
	name = command(1)
	chuansong = False
	waitExeStatus EXE_CS
    If teamStatus = TEAM_JOIN And Not isLeader Then 
    	chuansong = True
        log "非队长，不执行"
        Exit Function
    End If
    ret1 = lockWnd()
    dm.KeyPressChar "f1"
    shezhiX = 0
    shezhiY = 0
    For csTimes = 0 To 10
    	dm.FindPic 93,2,637,424, "img\zidong.bmp", "000000", 0.9, 0, shezhiX, shezhiY
    	If shezhiX > 0 And shezhiY > 0 Then 
    	 	Exit For
        End If
        
        Delay 200 + myRnd(100)
        If 6 = csTimes Then 
        	dm.KeyPressChar "f1"
        End If
    Next
    If shezhiX <= 0 Or shezhiY <= 0 Then 
        If ret1 Then
            unLockWnd
        End If
    	Exit Function
    End If
   
   	Delay 500 + myRnd(100)
    clickArea shezhiX + 90, shezhiY + 22, shezhiX + 119, shezhiY + 32
    Delay 20
    clickArea shezhiX + 90, shezhiY + 22, shezhiX + 119, shezhiY + 32
    Delay 100

    lastName = ""
    For csTimes = 0 To 12
    	tmpX = shezhiX - 72
    	tmpY = shezhiY + 66
        For mapIndex = 0 To 4
            mapName = getCS(tmpX, tmpY, tmpX + 95, tmpY + 17)
            TracePrint mapName
            If mapName = "" Then 
            	Delay 230
            	Exit For
            End If
            TracePrint mapIndex
            TracePrint mapName
            If mapIndex = 0 Then 
                If lastName <> "" And mapName = lastName Then 
                    lastName = ""
                    Exit For
                End If
                lastName = mapName
            End If
            If mapName = name Then 
                Exit For
            End If
            tmpY = tmpY + 16
        Next
        If mapName = name Then 
            Exit For
        End If
        If lastName = "" And mapName <> "" Then 
            Exit For
        End If
        For mapIndex = 0 To 4
        	If mapName = "" Then
            	Exit For
            End If
            clickArea shezhiX + 148, shezhiY + 139, shezhiX + 150, shezhiY + 141
            Delay 130
        Next
    Next
    If mapName = name Then 
    	clickArea tmpX + 10, tmpY + 7, tmpX + 80, tmpY + 15
    	Delay 100 + myRnd(20)
    	clickArea tmpX + 10, tmpY + 7, tmpX + 80, tmpY + 15
    	Delay 100 + myRnd(20)

    	clickArea shezhiX + 59,shezhiY + 268,shezhiX + 65, shezhiY + 274
    	Delay 100 + myRnd(20)
    	clickArea shezhiX + 4, shezhiY + 289, shezhiX + 50, shezhiY + 299
    	
    	Delay 800 + myRnd(100)
    	dm.KeyPressChar "f2"
        chuansong = True
    Else 
    	dm.KeyPressChar "f2"
    End If
    
    If ret1 Then
        unLockWnd
    End If
End Function

Function getGuajiStatus(isStop)
	Dim waitTimes,mapPos,lastX,lastY,isChange
	
    waitTimes = 0
    getGuajiStatus = 0
    isChange = False
    mapPos = getGamePos()
	lastX = mapPos(0)
	lastY = mapPos(1)
    For waitTimes = 0 To 20
    	If Not isFree(False)  Then 
    		setMsg "遇敌状态"
        	getGuajiStatus = 2
        	Exit Function
        End If
        Delay 300 + myRnd(10)
        mapPos = getGamePos()
		If lastX <> mapPos(0) Or lastY <> mapPos(1) Then 
			setMsg lastX & "," & lastY &" to " & mapPos(0) & "," & mapPos(1)
			isChange = True
			If isStop Then 
				Exit For	
			End If
		End If
    Next
    
    If isChange Then 
    	getGuajiStatus = 1
    End If
End Function

Function guajik(command, len)
    Dim mapName, ret1,mapPos, status, gTimes
    If len < 2 Then
        setMsg "guajik 命令至少需要1个参数"
    End If
    waitExeStatus EXE_GJ + 100
    guajik = False
    checkGuaji = True
    If (teamStatus = TEAM_JOIN And Not isLeader) Then 
    	guajiFlag = False
        guajik = True
        setMsg "非队长,不执行"
        Exit Function
    End If

    If guajiFlag Then 
    	setMsg "已经开始挂机"
        guajik = True
        Exit Function
    End If
    
    guajiFlag = False
    guajik = False
    mapPos = getGamePos()
	guajiX = mapPos(0)
	guajiY = mapPos(1)

    waitFree True
    mapName = getGameMap()
    If Not isSameMap(command(1), mapName) Then 
        log("地图不匹配")
        Exit Function
    End If
    
    setMsg "开始挂机"
    ret1 = lockWnd()
    keyStr "/1"
    Delay 300 + myRnd(100)
    dm.KeyPressChar "f5"
    If ret1 Then
        unLockWnd
    End If
    For gTimes = 0 To 2
    	status = getGuajiStatus(False)
    	If 2 = status Then 
    		guajiFlag = True
    		guajik = True
    		Exit For
    	ElseIf 0 = status Then
    		Exit For
    	ElseIf 1 = status Then
    		ret1 = lockWnd()
    		keyStr "/1"
    		If ret1 Then
        		unLockWnd
    		End If
     	End If
    	Delay 900
    Next
End Function

Function guajig()
    Dim checkTimes, status, ret1
    guajig = True
    If Not guajiFlag Then 
    	setMsg "未开始挂机"
        Exit Function
    End If
    
    waitExeStatus EXE_GJ + 100
    setMsg "停止挂机"
    If (teamStatus = TEAM_JOIN And Not isLeader) Then
        setMsg "非队长,不执行"
        Exit Function
    End If

    guajig = False
    ret1 = lockWnd()
    dm.KeyPressChar "f5"
    Delay 300 + myRnd(100)
    keyStr "/1"
    If ret1 Then
        unLockWnd
    End If
    
    waitFree True
    For gTimes = 0 To 2
    	status = getGuajiStatus(True)
    	If 0 = status Then 
    		guajiFlag = False
    		guajig = True
    		ret1 = lockWnd()
			walkTo getGameMap(), guajiX, guajiY, False
   			If ret1 Then
       			unLockWnd
    		End If
    		Exit For
    	ElseIf 2 = status Then
    		Exit For
    	ElseIf 1 = status Then
    		ret1 = lockWnd()
    		dm.KeyPressChar "f5"
    		If ret1 Then
        		unLockWnd
    		End If
     	End If
    	Delay 900
    Next
End Function

Function health(command, len1)
	If len1 < 3 Then
        setMsg "health 命令至少需要2个参数"
    End If
    
    Dim minX,minL,info
    
    health = True
    info = getCharInfo()
    minX = Clng(command(1))
    minL = Clng(command(2))
    If info(0) < minX Or info(1) < minL Then
        health = False
    End If
End Function

Function executeCommand(command, hasNext)
    Dim name, len1, ret1, ret2,status
    name = command(0)
    len1 = arrLen(command) 
    setMsg "执行" & ":" & Join(command)
    ret2 = True
    If name = "go" Then
        ret2 = go(command, len1, hasNext)
    ElseIf name = "gornd" Then
        ret2 = goRnd(command, len1)
    ElseIf name = "gooffset" Then
        ret2 = goOffset(command, len1)
    ElseIf name = "bteam" Then
        ret2 = breakTeam()
    ElseIf name = "cteam" Then
        ret2 = createTeam()
    ElseIf name = "home" Then
    	waitExeStatus EXE_JIHE
        ret2 = home()
        If checkGuaji Then 
        	status = getGuajiStatus(True)
            If 1 = status Then
                ret1 = lockWnd()
                dm.KeyPressChar "f5"
                If ret1 Then
                    unLockWnd
                End If
            End If
        End If
    ElseIf name = "item" Then
        ret2 = item(command, len1)
    ElseIf name = "chat" Then
        ret2 = chat(command, len1)
    ElseIf name = "yudi" Then
        ret2 = yudi(command, len1)
    ElseIf name = "sell" Then
        ret2 = sell(command, len1)
    ElseIf name = "cs" Then
        ret2 = chuansong(command, len1)
    ElseIf name = "jiaxue" Then
        ret2 = jiaxue(command, len1)
    ElseIf name = "guajik" Then
        ret2 = guajik(command, len1)
    ElseIf name = "guajig" Then
        ret2 = guajig()
    ElseIf name = "health" Then
        ret2 = health(command, len1)
    ElseIf name = "zhizao" Then
        ret2 = itemSkill(command, len1)
    ElseIf name = "czhizao" Then
        ret2 = itemSkillAndSell(command, len1)
    ElseIf name = "jihe" Then
    	waitExeStatus EXE_JIHE
        If isLeader And teamStatus = TEAM_JOIN Then 
            ret1 = lockWnd()
            together
            If ret1 Then
                unLockWnd
            End If	
        End If
        ret2 = True
    End If

    executeCommand = ret2
End Function
Function getCommand(commands, line)
    Dim attrNum, arr(10)
    For attrNum = 0 To 10
        If IsEmpty(commands(line - 1, attrNum)) Then 
            Exit For
        End If
        arr(attrNum) = commands(line - 1, attrNum)
    Next
    getCommand = arr
End Function
Function arrLen(arr1)
    Dim attrNum
    For attrNum = 0 To UBOUND(arr1)
        If IsEmpty(arr1(attrNum)) Then 
            Exit For
        End If
    Next
    arrLen = attrNum
End Function
Function getTaskName(tType)
    Dim arr1
    arr1 = readScript("script\task_" & tType & ".txt")
    If IsEmpty(arr1(0,0)) Then
        getTaskName = "无效操作"
        Exit Function
    End If
    getTaskName = arr1(0,0)
End Function
Function getCommandLines(arr1)
	Dim attrNum
    For attrNum = 0 To 100
        If IsEmpty(arr1(attrNum, 0)) Then 
            Exit For
        End If
    Next
    getCommandLines = attrNum
End Function
Function executeScript(fileName)
    Dim commands, exeLine, count, command, nextCommand, exeTimes, times, len1, ret1, errTimes,ret2
    setMsg "读取脚本数据"
    ret2 = lockWnd1()
    commands = readScript(fileName)
    Delay 288
    If ret2 Then 
    	unLockWnd1
    End If 
    If IsEmpty(commands(1, 0)) Then
        setMsg "脚本文件" & fileName & "不存在或者无效"
        Exit Function
    End If
    setMsg "读取脚本成功"
    command = getCommand(commands, 1)
    len1 = arrLen(command)
    If len1 < 2 Then 
    	setMsg "脚本执行配置无效"
    	Exit Function
    End If
    exeTimes = Clng(command(2))
    If command(1) = "team" Then 
    	setMsg "判断队长"
        checkLeader
    Else
        isLeader = True
        teamStatusMask = 0
        teamStatus = TEAM_NO
    End If
    times = 1
    count = getCommandLines(commands)
    guajiFlag = False
    checkGuaji = False
    errTimes = 0
    setMsg "开始执行脚本，共" & count - 1 & "条指令"
    Do While S_RUN = isRun
        For exeLine = 2 To count
        	If S_RUN <> isRun Then 
        		Exit For
        	End If
        	setMsg "执行 " & Join(command)
        	command = getCommand(commands, exeLine)        	
            If (exeLine < count) And command(0) = "go" Then 
            	nextCommand = getCommand(commands, exeLine + 1)
				If nextCommand(0) = "go" And nextCommand(1) = command(1) Then         	
            		ret1 = executeCommand(command, True)
            	Else 
            		ret1 = executeCommand(command, False)
            	End If
            Else 
            	ret1 = executeCommand(command, False)
            End If
            If Not ret1 Then
                errTimes = errTimes  + 1
                exeLine = exeLine - 1
                setMsg "执行 " & Join(command) & " 出错"
            Else
                errTimes = 0
                setMsg "执行 " & Join(command) & " 成功"
                If "guajik" <> command(0) Then 
                	waitFree False
                End If
            End If
            If errTimes > 2 Then 
            	errTimes = 0
                setMsg "出错过多重新开始"
                Exit For
            End If
        Next
        times = times + 1
        If (exeTimes > 0) And times > exeTimes Then
            Exit Do
        End If
    Loop
    guajig
End Function
Function myRnd(num)
    Randomize
    myRnd = Clng(rnd() * num)
End Function
Function bt1Event()
    Dim start, current
    wndIndex = 0
    operateName = "刷新窗口"
    start = Now
    current = Now
    statusMsg = operateName & " 当前状态：进行中 开始时间：" & start & " 当前时间：" & current
    flushWnd
    current = Now
    statusMsg = operateName & " 当前状态：已结束 开始时间：" & start & " 结束时间：" & current
    isRun = S_STOP
End Function
Event p1.bt1.Click
    If 0 = eventThreadId Then 
        eventThreadId = BeginThread(eventRun)
    End If
    If isRun <> S_STOP Then 
        MsgBox "请先停止执行！"
        Exit Event
    End If
    disableControls 
    eventType = 1
    lastEventType = eventType
End Event
Function bt2Event()
    taskType = TASK_1
    operateName = getTaskName(taskType)
    startTask 
    isRun = S_STOP
End Function
Event p1.bt2.Click
    selectWnds = 0
    If isRun <> S_STOP Then 
        MsgBox "请先停止执行！"
        Exit Event
    End If
    initSelected 
    If 0 = selectWnds Then 
        MsgBox "请先选中窗口！" 
        Exit Event
    End If
    disableControls 
    eventType = 2
    lastEventType = eventType
End Event
Function bt3Event()
    taskType = TASK_2
    operateName = getTaskName(taskType)
    startTask 
    isRun = S_STOP
End Function
Event p1.bt3.Click
    selectWnds = 0
    If isRun <> S_STOP Then 
        MsgBox "请先停止执行！"
        Exit Event
    End If
    initSelected 
    If 0 = selectWnds Then 
        MsgBox "请先选中窗口！" 
        Exit Event
    End If
    disableControls 
    eventType = 3
    lastEventType = eventType
End Event
Function bt4Event()
    taskType = TASK_3
    operateName = getTaskName(taskType)
    startTask 
    isRun = S_STOP
End Function
Event p1.bt4.Click
    selectWnds = 0
    If isRun <> S_STOP Then 
        MsgBox "请先停止执行！"
        Exit Event
    End If
    initSelected 
    If 0 = selectWnds Then 
        MsgBox "请先选中窗口！" 
        Exit Event
    End If
    disableControls 
    eventType = 4
    lastEventType = eventType
End Event
Function bt5Event()
    taskType = TASK_4
    operateName = getTaskName(taskType)
    startTask 
    isRun = S_STOP
End Function
Event p1.bt5.Click
    selectWnds = 0
    If isRun <> S_STOP Then 
        MsgBox "请先停止执行！"
        Exit Event
    End If
    initSelected 
    If 0 = selectWnds Then 
        MsgBox "请先选中窗口！" 
        Exit Event
    End If
    disableControls 
    eventType = 5
    lastEventType = eventType
End Event
Function bt6Event()
    taskType = TASK_5
    operateName = getTaskName(taskType)
    startTask 
    isRun = S_STOP
End Function
Event p1.bt6.Click
    selectWnds = 0
    If isRun <> S_STOP Then 
        MsgBox "请先停止执行！"
        Exit Event
    End If
    initSelected 
    If 0 = selectWnds Then 
        MsgBox "请先选中窗口！" 
        Exit Event
    End If
    disableControls 
    eventType = 6
    lastEventType = eventType
End Event
Function bt7Event()
    taskType = TASK_6
    operateName = getTaskName(taskType)
    startTask 
    isRun = S_STOP
End Function
Event p1.bt7.Click
    selectWnds = 0
    If isRun <> S_STOP Then 
        MsgBox "请先停止执行！"
        Exit Event
    End If
    initSelected 
    If 0 = selectWnds Then 
        MsgBox "请先选中窗口！" 
        Exit Event
    End If
    disableControls 
    eventType = 7
    lastEventType = eventType
End Event
Function bt8Event()
    taskType = TASK_7
    operateName = getTaskName(taskType)
    startTask 
    isRun = S_STOP
End Function
Event p1.bt8.Click
    selectWnds = 0
    If isRun <> S_STOP Then 
        MsgBox "请先停止执行！"
        Exit Event
    End If
    initSelected 
    If 0 = selectWnds Then 
        MsgBox "请先选中窗口！" 
        Exit Event
    End If
    disableControls 
    eventType = 8
    lastEventType = eventType
End Event
Function bt9Event()
    taskType = TASK_8
    operateName = getTaskName(taskType)
    startTask 
    isRun = S_STOP
End Function
Event p1.bt9.Click
    selectWnds = 0
    If isRun <> S_STOP Then 
        MsgBox "请先停止执行！"
        Exit Event
    End If
    initSelected 
    If 0 = selectWnds Then 
        MsgBox "请先选中窗口！" 
        Exit Event
    End If
    disableControls 
    eventType = 9
    lastEventType = eventType
End Event
Function bt10Event()
    taskType = TASK_9
    operateName = getTaskName(taskType)
    startTask 
    isRun = S_STOP
End Function
Event p1.bt10.Click
    selectWnds = 0
    If isRun <> S_STOP Then 
        MsgBox "请先停止执行！"
        Exit Event
    End If
    initSelected 
    If 0 = selectWnds Then 
        MsgBox "请先选中窗口！" 
        Exit Event
    End If
    disableControls 
    eventType =10
    lastEventType = eventType
End Event
Function eventRun
    Dim tmpEventType
    init 
    initDm 
    Do While (isRun <> S_EXIT)
        tmpEventType = eventType
        If tmpEventType > 0 Then 
            p1.Timer1.Enabled = False
            p1.Timer1.Enabled = True
            eventType = 0
        End If
        If 0 = tmpEventType Then
            Delay 200
        ElseIf 1 = tmpEventType Then
            bt1Event
        ElseIf 2 = tmpEventType Then
            bt2Event
        ElseIf 3 = tmpEventType Then
            bt3Event
        ElseIf 4 = tmpEventType Then
            bt4Event
        ElseIf 5 = tmpEventType Then
            bt5Event
        ElseIf 6 = tmpEventType Then
            bt6Event
        ElseIf 7 = tmpEventType Then
            bt7Event
        ElseIf 8 = tmpEventType Then
            bt8Event 
        ElseIf 9 = tmpEventType Then
            bt9Event 
        ElseIf 10 = tmpEventType Then
            bt10Event
        End If
    Loop
End Function
Event p1.Load
    initEnv 
    initDm 
    dm.DmGuard 1, "phide"
    dm.DmGuard 1,"np"
    p1.bt2.Caption = getTaskName(TASK_1)
    p1.bt3.Caption = getTaskName(TASK_2)
    p1.bt4.Caption = getTaskName(TASK_3)
    p1.bt5.Caption = getTaskName(TASK_4)
    p1.bt6.Caption = getTaskName(TASK_5)
    p1.bt7.Caption = getTaskName(TASK_6)
    p1.bt8.Caption = getTaskName(TASK_7)
    p1.bt9.Caption = getTaskName(TASK_8)
    p1.bt10.Caption = getTaskName(TASK_9)
    p1.Timer1.Enabled = False
    p1.Timer1.Interval = 1000
    eventThreadId = 0
End Event
Event p1.UnLoad
    isRun = S_EXIT
    Delay 600
    If eventThreadId <> 0 Then 
        StopThread eventThreadId	
    End If
End Event
Event p1.stop.Click
    If isRun = S_RUN Then 
        isRun = S_WAIT
        p1.stop.Enabled = 0
    End If
End Event
Event p1.Timer1.Timer
    Dim current
    current = Now
    If p1.pLog.Caption <> statusMsg Then 
        p1.pLog.Caption = statusMsg
    End If
    If p1.msg1.Caption <> msg1 Then 
        p1.msg1.Caption = msg1
    End If
    If p1.msg2.Caption <> msg2 Then 
        p1.msg2.Caption = msg2
    End If
    If p1.msg3.Caption <> msg3 Then 
        p1.msg3.Caption = msg3
    End If
    If p1.msg4.Caption <> msg4 Then 
        p1.msg4.Caption = msg4
    End If
    If p1.msg5.Caption <> msg5 Then 
        p1.msg5.Caption = msg5
    End If
    If p1.msg6.Caption <> msg6 Then 
        p1.msg6.Caption = msg6
    End If
    
    If isRun = S_STOP Then 
        If 1 = lastEventType Then
            If "" <> wnd1Name Then 
                p1.wnd1.Caption = wnd1Name
                p1.wnd1.Visible = 1
            Else
                p1.wnd1.Visible = 0
                p1.wnd1.Value = 0
            End If
            If "" <> wnd2Name Then 
                p1.wnd2.Caption = wnd2Name
                p1.wnd2.Visible = 1
            Else
                p1.wnd2.Visible = 0
                p1.wnd2.Value = 0
            End If
            If "" <> wnd3Name Then 
                p1.wnd3.Caption = wnd3Name
                p1.wnd3.Visible = 1
            Else
                p1.wnd3.Visible = 0
                p1.wnd3.Value = 0
            End If
            If "" <> wnd4Name Then 
                p1.wnd4.Caption = wnd4Name
                p1.wnd4.Visible = 1
            Else
                p1.wnd4.Visible = 0
                p1.wnd4.Value = 0
            End If
            If "" <> wnd5Name Then 
                p1.wnd5.Caption = wnd5Name
                p1.wnd5.Visible = 1
            Else
                p1.wnd5.Visible = 0
                p1.wnd5.Value = 0
            End If
            If "" <> wnd6Name Then 
                p1.wnd6.Caption = wnd6Name
                p1.wnd6.Visible = 1
            Else
                p1.wnd6.Visible = 0
                p1.wnd6.Value = 0
            End If
        End If
        p1.Timer1.Enabled = False
        lastEventType = 0
        enableControls 
        enableControls 
    End If

End Event


ExitScript
Dim hwnds
init
initEnv 
initDm 
hwnds = dm.EnumWindowByProcess("ajml.exe", "魔力", "", 25)

arr = split(hwnds, ",")
count = UBOUND(arr)
For i = 0 To count
	hwnd = Clng(arr(i))
    If dm.GetWindowState(hwnd, 3) = 0 Then    
        wndHwnd = hwnd
        currentLockIndex = 1
        wnd2NeedLock = True
        wndIndex = 1
        isLeader = True
        teamStatus = TEAM_NO
        teamStatusMask = (2 ^ wndIndex)
        ret = dm.BindWindow(hwnd, "gdi", "normal", "normal", 0)
        'ret = dm.BindWindowEx(hwnd, "gdi", "dx.mouse.position.lock.api|dx.mouse.position.lock.message", "normal", "", 0)
        isRun = S_RUN
        initMapPos
        
        Plugin.Window.Active wndHwnd
        
        'tmparr1 = split("sell,8,tongtiao,mabu", ",")
        'tmparr1 = split("zhizao,造头盔,铜制头盔,tongtiao,mabu", ",")
        tmparr1 = split("cs,奇利村", ",")
        chuansong tmparr1, 2
		'itemSkill tmparr1,5
        'ret = findMyPic(411,139,602,248, itemPic, True)
        dm.UnBindWindow 
        Exit For
    End If
Next